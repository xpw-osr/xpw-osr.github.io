<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>Spring Security: Data Access Authorization with ACL | Simple Journey</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/2.0.4/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/2.1.4/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/2.1.4/toastr.min.css"><meta name="generator" content="Hexo 5.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Spring Security: Data Access Authorization with ACL</h1><a id="logo" href="/.">Simple Journey</a><p class="description">Every Little Helps</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/tags/"><i class="fa fa-tag"> Tags</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Spring Security: Data Access Authorization with ACL</h1><div class="post-meta">2020-07-29<span> | </span><span class="category"><a href="/categories/Spring-Boot/">Spring Boot</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">Contents</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Story"><span class="toc-number">1.</span> <span class="toc-text">Story</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Analysis"><span class="toc-number">2.</span> <span class="toc-text">Analysis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Implementation"><span class="toc-number">3.</span> <span class="toc-text">Implementation</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Database-Definition"><span class="toc-number">3.1.</span> <span class="toc-text">Database Definition</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ACL-Support"><span class="toc-number">3.2.</span> <span class="toc-text">ACL Support</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Business-Logic"><span class="toc-number">3.3.</span> <span class="toc-text">Business Logic</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Test"><span class="toc-number">4.</span> <span class="toc-text">Test</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Add-SwaggerUI-Support"><span class="toc-number">4.1.</span> <span class="toc-text">Add SwaggerUI Support</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Test-Cases"><span class="toc-number">4.2.</span> <span class="toc-text">Test Cases</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Case-1"><span class="toc-number">4.2.1.</span> <span class="toc-text">Case 1:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Case-2"><span class="toc-number">4.2.2.</span> <span class="toc-text">Case 2:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Case-3"><span class="toc-number">4.2.3.</span> <span class="toc-text">Case 3:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Others"><span class="toc-number">4.2.4.</span> <span class="toc-text">Others</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Conclusion"><span class="toc-number">5.</span> <span class="toc-text">Conclusion</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#References"><span class="toc-number">6.</span> <span class="toc-text">References</span></a></li></ol></div></div><div class="post-content"><p>In previous posts, we discussed how to use Spring Security to authenticate user and authorizate user’s requests. But all of those only can manage the permissions on API level. In many scenarios, we also need make sure user only can access the data which they owned or permitted. In this post, I will show how to use Spring Security ACL to make it.</p>
<h3 id="Story"><a href="#Story" class="headerlink" title="Story"></a>Story</h3><p>Suppose we will provide a notes service on cloud to make users can access them at anywhere. And there are some basic requirements which we need implement.</p>
<ul>
<li>All users can read, write, update and delete their owned notes</li>
<li>All users can create group(s) for family, friends and others</li>
<li>All users can share special note(s) which their owned to public, group(s) and speical user(s)</li>
<li>Users can manage the permissions of their shared note for each target. Such as, some targets only can read it, and some others can read and update it. And also, users can stop sharing.</li>
</ul>
<h3 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h3><p>With above requirements, we know</p>
<ul>
<li>All users should can request creating (POST), updating (PUT), getting (GET), deleting (DELETE) APIs. It means, users need access all REST APIs of note</li>
<li>Owner of notes has full permissions to manage them</li>
<li>Besides their owned, users can access the notes with special permission(s) which are shared to them by other users</li>
</ul>
<p>Therefore, we need separate the authorization to 2 levels - API level and data level.</p>
<h3 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h3><p>Let’s start to make them to true.</p>
<p>The demo of this post will use JWT token between frontend and backend. API level is same as previous posts. Related things you can read <a href="https://xpw-osr.github.io/2020/05/13/spring-security-authentication-and-authorization-with-jwt-for-separated-backend/">Spring Security: Authentication and Authorization with JWT for separated backend</a>. We only discuss how to control the permissions on data level.</p>
<p>Now, create project with dependences.</p>
<p><strong>build.gradle</strong></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">	id <span class="string">&#x27;org.springframework.boot&#x27;</span> version <span class="string">&#x27;2.2.7.RELEASE&#x27;</span></span><br><span class="line">	id <span class="string">&#x27;io.spring.dependency-management&#x27;</span> version <span class="string">&#x27;1.0.9.RELEASE&#x27;</span></span><br><span class="line">	id <span class="string">&#x27;java&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">group = <span class="string">&#x27;com.simplejourney&#x27;</span></span><br><span class="line">version = <span class="string">&#x27;0.0.1-SNAPSHOT&#x27;</span></span><br><span class="line">sourceCompatibility = <span class="string">&#x27;1.8&#x27;</span></span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">	mavenCentral()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">	implementation <span class="string">&#x27;org.postgresql:postgresql:42.2.12&#x27;</span></span><br><span class="line">	implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-data-jpa&#x27;</span></span><br><span class="line">	implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-jdbc&#x27;</span></span><br><span class="line">	implementation <span class="string">&#x27;org.springframework.security:spring-security-acl&#x27;</span></span><br><span class="line">	implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-security&#x27;</span></span><br><span class="line">	implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-web&#x27;</span></span><br><span class="line"></span><br><span class="line">	implementation <span class="string">&#x27;io.jsonwebtoken:jjwt:0.2&#x27;</span></span><br><span class="line">	implementation <span class="string">&#x27;com.google.code.gson:gson:2.8.6&#x27;</span></span><br><span class="line">	implementation <span class="string">&#x27;net.sf.ehcache:ehcache-core:2.6.11&#x27;</span></span><br><span class="line">	implementation <span class="string">&#x27;org.springframework:spring-context-support:5.2.6.RELEASE&#x27;</span></span><br><span class="line"></span><br><span class="line">	implementation <span class="string">&#x27;io.springfox:springfox-swagger2:2.4.0&#x27;</span></span><br><span class="line">	implementation <span class="string">&#x27;io.springfox:springfox-swagger-ui:2.4.0&#x27;</span></span><br><span class="line"></span><br><span class="line">	compileOnly <span class="string">&#x27;org.projectlombok:lombok:1.18.12&#x27;</span></span><br><span class="line">	annotationProcessor <span class="string">&#x27;org.projectlombok:lombok:1.18.12&#x27;</span></span><br><span class="line"></span><br><span class="line">	testImplementation(<span class="string">&#x27;org.springframework.boot:spring-boot-starter-test&#x27;</span>) &#123;</span><br><span class="line">		exclude <span class="attr">group:</span> <span class="string">&#x27;org.junit.vintage&#x27;</span>, <span class="attr">module:</span> <span class="string">&#x27;junit-vintage-engine&#x27;</span></span><br><span class="line">	&#125;</span><br><span class="line">	testImplementation <span class="string">&#x27;org.springframework.security:spring-security-test&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test &#123;</span><br><span class="line">	useJUnitPlatform()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>To add ACL support, following packages are needed</p>
<ul>
<li><p><strong>spring-security-acl:</strong></p>
<p>Spring ACL package</p>
</li>
<li><p><strong>ehcache-core:</strong></p>
<p>Spring ACL requires a cache to store Object Identity and ACL entries.</p>
</li>
<li><p><strong>DB support packages. The JPA and PostgreSQL are used in this demo</strong></p>
<ul>
<li>spring-boot-starter-data-jpa</li>
<li>spring-boot-starter-jdbc</li>
<li>postgresql</li>
</ul>
</li>
</ul>
<p><strong>application.yml</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jwt:</span></span><br><span class="line">  <span class="attr">secret:</span> <span class="string">securityjwt</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:postgresql://127.0.0.1:5432/demo</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">demo</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">driverClassName:</span> <span class="string">org.postgresql.Driver</span></span><br><span class="line">    <span class="attr">jdbc-url:</span> <span class="string">jdbc:postgresql://127.0.0.1:5432/demo</span></span><br><span class="line">  <span class="attr">jpa:</span></span><br><span class="line">    <span class="attr">hibernate:</span></span><br><span class="line">      <span class="attr">naming:</span></span><br><span class="line">        <span class="attr">implicit-strategy:</span> <span class="string">org.hibernate.boot.model.naming.ImplicitNamingStrategyLegacyJpaImpl</span></span><br><span class="line">        <span class="attr">physical-strategy:</span> <span class="string">org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl</span></span><br><span class="line">      <span class="attr">dialect:</span> <span class="string">org.hibernate.dialect.PostgreSQL10Dialect</span></span><br></pre></td></tr></table></figure>
<p>Why we defined db connection url 2 times? </p>
<p>There are 2 different models use different field name under ‘spring.datasource’. </p>
<ul>
<li>spring.datasource.url : used by JPA</li>
<li>spring.datasource.jdbc-url : used by ACL DataSource</li>
</ul>
<h4 id="Database-Definition"><a href="#Database-Definition" class="headerlink" title="Database Definition"></a>Database Definition</h4><p><strong>db.sql</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ACL Tables</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ACL_SID table, allows us to universally identify any principle or authority in the system</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> acl_sid (</span><br><span class="line">	id BIGSERIAL <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>,</span><br><span class="line">	sid <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	principal <span class="type">BOOLEAN</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	<span class="keyword">CONSTRAINT</span> unique_uk_1 <span class="keyword">UNIQUE</span>(sid, principal)</span><br><span class="line">);</span><br><span class="line">COMMENT <span class="keyword">ON</span> <span class="keyword">COLUMN</span> acl_sid.principal <span class="keyword">IS</span> <span class="string">&#x27;if true, sid is instance of PrincipalSid which indicates username; otherwise, it is instance of GrantedAuthoritySid which indicates the role&#x27;</span>;</span><br><span class="line">COMMENT <span class="keyword">ON</span> <span class="keyword">COLUMN</span> acl_sid.sid <span class="keyword">IS</span> <span class="string">&#x27;PrincipalSid (user) or GrantedAuthoritySid (role)&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ACL_CLASS table, store class name of the domain object</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> acl_class (</span><br><span class="line">	id BIGSERIAL <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>,</span><br><span class="line">	class <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	<span class="keyword">CONSTRAINT</span> unique_uk_2 <span class="keyword">UNIQUE</span>(class)</span><br><span class="line">);</span><br><span class="line">COMMENT <span class="keyword">ON</span> <span class="keyword">COLUMN</span> acl_class.class <span class="keyword">IS</span> <span class="string">&#x27;the class name of secured domain objects. for example: com.simplejourney.securityacl.entities.User&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ACL_OBJECT_IDENTITY table, which stores information for each unique domain object</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> acl_object_identity (</span><br><span class="line">	id BIGSERIAL <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>, </span><br><span class="line">	object_id_class <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	object_id_identity <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	parent_object <span class="type">BIGINT</span>,</span><br><span class="line">	owner_sid <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	entries_inheriting <span class="type">BOOLEAN</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	<span class="keyword">CONSTRAINT</span> unique_uk_3 <span class="keyword">UNIQUE</span>(object_id_class, object_id_identity),</span><br><span class="line">	<span class="keyword">CONSTRAINT</span> foreign_fk_1 <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span>(parent_object) <span class="keyword">REFERENCES</span> acl_object_identity(id),</span><br><span class="line">	<span class="keyword">CONSTRAINT</span> foreign_fk_2 <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span>(object_id_class) <span class="keyword">REFERENCES</span> acl_class(id),</span><br><span class="line">	<span class="keyword">CONSTRAINT</span> foreign_fk_3 <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span>(owner_sid) <span class="keyword">REFERENCES</span> acl_sid(id)</span><br><span class="line">);</span><br><span class="line">COMMENT <span class="keyword">ON</span> <span class="keyword">COLUMN</span> acl_object_identity.object_id_class <span class="keyword">IS</span> <span class="string">&#x27;define the domain object class, links to ACL_CLASS table&#x27;</span>;</span><br><span class="line">COMMENT <span class="keyword">ON</span> <span class="keyword">COLUMN</span> acl_object_identity.object_id_identity <span class="keyword">IS</span> <span class="string">&#x27;domain objects can be stored in many tables depending on the class. Hence, this field store the target object primary key&#x27;</span>;</span><br><span class="line">COMMENT <span class="keyword">ON</span> <span class="keyword">COLUMN</span> acl_object_identity.parent_object <span class="keyword">IS</span> <span class="string">&#x27;specify parent of this Object Identity within this table&#x27;</span>;</span><br><span class="line">COMMENT <span class="keyword">ON</span> <span class="keyword">COLUMN</span> acl_object_identity.owner_sid <span class="keyword">IS</span> <span class="string">&#x27;ID of the object owner, links to ACL_SID table&#x27;</span>;</span><br><span class="line">COMMENT <span class="keyword">ON</span> <span class="keyword">COLUMN</span> acl_object_identity.entries_inheriting <span class="keyword">IS</span> <span class="string">&#x27;whether ACL Entities of this object inherits from the parent object (ACL Entries are defined in ACL_ENTRY table&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- the ACL_ENTRY store individual permission assigns to each SID on an Object Identity</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> acl_entry (</span><br><span class="line">	id BIGSERIAL <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>,</span><br><span class="line">	acl_object_identity <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	ace_order <span class="type">INTEGER</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	sid <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	mask <span class="type">INTEGER</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	granting <span class="type">BOOLEAN</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	audit_success <span class="type">BOOLEAN</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	audit_failure <span class="type">BOOLEAN</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	<span class="keyword">CONSTRAINT</span> unique_uk_4 <span class="keyword">UNIQUE</span>(acl_object_identity, ace_order),</span><br><span class="line">	<span class="keyword">CONSTRAINT</span> foreign_fk_4 <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span>(acl_object_identity) <span class="keyword">REFERENCES</span> acl_object_identity(id),</span><br><span class="line">	<span class="keyword">CONSTRAINT</span> foreign_fk_5 <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span>(sid) <span class="keyword">REFERENCES</span> acl_sid(id)</span><br><span class="line">);</span><br><span class="line">COMMENT <span class="keyword">ON</span> <span class="keyword">COLUMN</span> acl_entry.acl_object_identity <span class="keyword">IS</span> <span class="string">&#x27;specify the object identity, links to ACL_OBJECT_IDENTITY table&#x27;</span>;</span><br><span class="line">COMMENT <span class="keyword">ON</span> <span class="keyword">COLUMN</span> acl_entry.ace_order <span class="keyword">IS</span> <span class="string">&#x27;the order of current entry in the ACL entries list of corresponding Object Identity&#x27;</span>;</span><br><span class="line">COMMENT <span class="keyword">ON</span> <span class="keyword">COLUMN</span> acl_entry.sid <span class="keyword">IS</span> <span class="string">&#x27;the target SID which the permission is granted to or denied from, links to ACL_SID table&#x27;</span>;</span><br><span class="line">COMMENT <span class="keyword">ON</span> <span class="keyword">COLUMN</span> acl_entry.mask <span class="keyword">IS</span> <span class="string">&#x27;the integer bit mask that represents the actual permission being granted or denied&#x27;</span>;</span><br><span class="line">COMMENT <span class="keyword">ON</span> <span class="keyword">COLUMN</span> acl_entry.audit_success <span class="keyword">IS</span> <span class="string">&#x27;for auditing purpose&#x27;</span>;</span><br><span class="line">COMMENT <span class="keyword">ON</span> <span class="keyword">COLUMN</span> acl_entry.audit_failure <span class="keyword">IS</span> <span class="string">&#x27;for auditing purpose&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * User, Group, Role, Permission</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> users (</span><br><span class="line">	id BIGSERIAL <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>,</span><br><span class="line">	name <span class="type">VARCHAR</span>(<span class="number">36</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	password <span class="type">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	<span class="keyword">CONSTRAINT</span> unique_uk_name <span class="keyword">UNIQUE</span>(name)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> users (name, password) <span class="keyword">VALUES</span> (<span class="string">&#x27;tom&#x27;</span>, <span class="string">&#x27;$2a$10$slYQmyNdGzTn7ZLBXBChFOCHQhUkTikWVg2V95lHK7HRj/LPjaZIa&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> users (name, password) <span class="keyword">VALUES</span> (<span class="string">&#x27;jerry&#x27;</span>, <span class="string">&#x27;$2a$10$slYQmyNdGzTn7ZLBXBChFOCHQhUkTikWVg2V95lHK7HRj/LPjaZIa&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> users (name, password) <span class="keyword">VALUES</span> (<span class="string">&#x27;nibbles&#x27;</span>, <span class="string">&#x27;$2a$10$slYQmyNdGzTn7ZLBXBChFOCHQhUkTikWVg2V95lHK7HRj/LPjaZIa&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> users (name, password) <span class="keyword">VALUES</span> (<span class="string">&#x27;spike&#x27;</span>, <span class="string">&#x27;$2a$10$slYQmyNdGzTn7ZLBXBChFOCHQhUkTikWVg2V95lHK7HRj/LPjaZIa&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">groups</span> (</span><br><span class="line">	id BIGSERIAL <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>,</span><br><span class="line">	name <span class="type">VARCHAR</span>(<span class="number">36</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">groups</span> (name) <span class="keyword">VALUES</span> (<span class="string">&#x27;family&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user_group (</span><br><span class="line">	id BIGSERIAL <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>,</span><br><span class="line">	user_id <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	group_id <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	<span class="keyword">CONSTRAINT</span> foreign_fk_user_id <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span>(user_id) <span class="keyword">REFERENCES</span> users(id),</span><br><span class="line">	<span class="keyword">CONSTRAINT</span> foreign_fk_group_id <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span>(group_id) <span class="keyword">REFERENCES</span> <span class="keyword">groups</span>(id)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user_group (user_id, group_id) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>); <span class="comment">-- add Tom to &#x27;family&#x27; group</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user_group (user_id, group_id) <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">1</span>); <span class="comment">-- add Jerry to &#x27;family&#x27; group</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Business Data</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> note (</span><br><span class="line">	id BIGSERIAL <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	title <span class="type">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	content TEXT <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	create_date <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	author_id <span class="type">BIGINT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	<span class="keyword">CONSTRAINT</span> foreign_fk_author_id <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span>(author_id) <span class="keyword">REFERENCES</span> users(id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>The details of ‘ACL Tables’ see <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/site/docs/current/reference/html5/#dbschema-acl">Spring Security Reference: 22.3 ACL Schema</a>.</p>
<p>There is a different point in ‘acl_entry’ table, the ‘acl_object_identity’ field is BIGINT here but it is ‘VARCHAR(36)’ in document. This change is used to solve the issue of JdbcMutableAclService and BasicLookupStrategy. We will discuss it when we talk about ‘AclConfiguration’ class at below.</p>
<p>In our story, users can share their owned notes to other user(s), group(s) and public. So, we need create tables to manage them.</p>
<p>The ‘users’ table only contains the username and password, and the ‘name’ column is unique since the UserDetailService use username to load details during authentication and authorization. In real world, you also can use email or phone number as query parameter for UserDetailService.</p>
<p>Then ‘groups’ table only need name in our demo. And associated with user by ‘user_group’ table.</p>
<p>There is not Role and API related tables, we don’t need them. In our story, all APIs are opened for all registered users.</p>
<h4 id="ACL-Support"><a href="#ACL-Support" class="headerlink" title="ACL Support"></a>ACL Support</h4><p><strong>AclConfiguration.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityacl.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> net.sf.ehcache.CacheManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.jdbc.DataSourceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.ehcache.EhCacheFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.ehcache.EhCacheManagerFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.access.expression.method.DefaultMethodSecurityExpressionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.access.expression.method.MethodSecurityExpressionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.acls.domain.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.acls.jdbc.BasicLookupStrategy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.acls.jdbc.JdbcMutableAclService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.acls.jdbc.LookupStrategy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.acls.model.AclCache;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.acls.model.AclService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.acls.model.PermissionGrantingStrategy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AclConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AclService aclService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JdbcMutableAclService <span class="title">aclService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JdbcMutableAclService aclService = <span class="keyword">new</span> JdbcMutableAclService(</span><br><span class="line">                dataSource(),</span><br><span class="line">                lookupStrategy(),</span><br><span class="line">                aclCache()</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        aclService.setClassIdentityQuery(<span class="string">&quot;select currval(pg_get_serial_sequence(&#x27;acl_class&#x27;, &#x27;id&#x27;))&quot;</span>);</span><br><span class="line">        aclService.setSidIdentityQuery(<span class="string">&quot;select currval(pg_get_serial_sequence(&#x27;acl_sid&#x27;, &#x27;id&#x27;))&quot;</span>);</span><br><span class="line">        aclService.setObjectIdentityPrimaryKeyQuery(<span class="string">&quot;select acl_object_identity.id from acl_object_identity, acl_class where acl_object_identity.object_id_class = acl_class.id and acl_class.class=? and acl_object_identity.object_id_identity = cast(? as bigint)&quot;</span>);</span><br><span class="line">        aclService.setFindChildrenQuery(<span class="string">&quot;select obj.object_id_identity as obj_id, class.class as class from acl_object_identity obj, acl_object_identity parent, acl_class class where obj.parent_object = parent.id and obj.object_id_class = class.id and parent.object_id_identity = cast(? as bigint) and parent.object_id_class = (select id FROM acl_class where acl_class.class = ?)&quot;</span>);</span><br><span class="line">        aclService.setInsertObjectIdentitySql(<span class="string">&quot;insert into acl_object_identity (object_id_class, object_id_identity, owner_sid, entries_inheriting) values (?, cast(? as bigint), ?, ?)&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> aclService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AclCache <span class="title">aclCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        EhCacheFactoryBean factoryBean = <span class="keyword">new</span> EhCacheFactoryBean();</span><br><span class="line">        EhCacheManagerFactoryBean cacheManagerFactoryBean = <span class="keyword">new</span> EhCacheManagerFactoryBean();</span><br><span class="line"></span><br><span class="line">        cacheManagerFactoryBean.setAcceptExisting(<span class="keyword">true</span>);</span><br><span class="line">        cacheManagerFactoryBean.setCacheManagerName(CacheManager.getInstance().getName());</span><br><span class="line">        cacheManagerFactoryBean.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">        factoryBean.setName(<span class="string">&quot;aclCache&quot;</span>);</span><br><span class="line">        factoryBean.setCacheManager(cacheManagerFactoryBean.getObject());</span><br><span class="line">        factoryBean.setMaxBytesLocalHeap(<span class="string">&quot;10M&quot;</span>);</span><br><span class="line">        factoryBean.setMaxEntriesLocalHeap(<span class="number">0L</span>);</span><br><span class="line">        factoryBean.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EhCacheBasedAclCache(factoryBean.getObject(), grantingStrategy(), aclAuthorizationStrategy());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuditLogger <span class="title">auditLogger</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ConsoleAuditLogger();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LookupStrategy <span class="title">lookupStrategy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        BasicLookupStrategy lookupStrategy = <span class="keyword">new</span> BasicLookupStrategy(</span><br><span class="line">                dataSource(),</span><br><span class="line">                aclCache(),</span><br><span class="line">                aclAuthorizationStrategy(),</span><br><span class="line">                grantingStrategy()</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        lookupStrategy.setLookupObjectIdentitiesWhereClause(<span class="string">&quot;(acl_object_identity.object_id_identity = cast(? as bigint) and acl_class.class = ?)&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> lookupStrategy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PermissionGrantingStrategy <span class="title">grantingStrategy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Use customized PermissionGrantingStrategy</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DemoPermissionGrantingStrategy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AclAuthorizationStrategy <span class="title">aclAuthorizationStrategy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AclAuthorizationStrategyImpl(</span><br><span class="line">          			<span class="comment">// authority which is used to change owner</span></span><br><span class="line">                <span class="keyword">new</span> SimpleGrantedAuthority(<span class="string">&quot;ROLE_ADMIN&quot;</span>),</span><br><span class="line">          			<span class="comment">// authority which is used to change authorization</span></span><br><span class="line">                <span class="keyword">new</span> SimpleGrantedAuthority(<span class="string">&quot;EDITOR&quot;</span>),</span><br><span class="line">			          <span class="comment">// authority which is used to chage other information. </span></span><br><span class="line">          			<span class="comment">// Changes ACL will use this.</span></span><br><span class="line">                <span class="keyword">new</span> SimpleGrantedAuthority(<span class="string">&quot;EDITOR&quot;</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * If we want to customize how to check security expression, </span></span><br><span class="line"><span class="comment">     * we can implement our own MethodSecurityExpressionHandler,</span></span><br><span class="line"><span class="comment">     * and create it here</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MethodSecurityExpressionHandler <span class="title">expressionHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultMethodSecurityExpressionHandler expressionHandler = <span class="keyword">new</span> DefaultMethodSecurityExpressionHandler();</span><br><span class="line">        expressionHandler.setPermissionEvaluator(aclPermissionEvaluator);</span><br><span class="line">        <span class="keyword">return</span> expressionHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DemoAclPermissionEvaluator aclPermissionEvaluator;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DemoAclPermissionEvaluator <span class="title">aclPermissionEvaluator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Use customized AclPermissionEvaluator and build-in BasePermission</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        DemoAclPermissionEvaluator aclPermissionEvaluator = <span class="keyword">new</span> DemoAclPermissionEvaluator(aclService);</span><br><span class="line">        aclPermissionEvaluator.setPermissionFactory(<span class="keyword">new</span> DefaultPermissionFactory(BasePermission.class));</span><br><span class="line">        <span class="keyword">return</span> aclPermissionEvaluator;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>To provide ACL support, we only need to provide an AclService instance to operate and manage the permissions of user data.</p>
<p>Creates an AclService object, it need 3 arguments. </p>
<ul>
<li>DataSource: access the acl tables in database</li>
<li>AclCache: cache the Object Identify and Acl entities in memory</li>
<li>LookupStrategy: lookup acl recodes for authorizing and granting permission</li>
</ul>
<p>There are some chance to customize the logic of ACL on expression and authorization to match our own requirements.</p>
<p>To customize the expression operation, we can implement our own ‘AclPermissionEvaluator’; and ‘AclAuthorizationStrategy’ and ‘PermissionGrantingStrategy’ for authorization policies.</p>
<p>And also, if you need your special permission settings, you can extends the ‘BasePermission’ class to make them.</p>
<p>There is something need to be noticed. You must already found there are some sqls are defined in ‘aclService’ method. And we also changed the data type of ‘acl_object_identity’ in ‘acl_entry’ table. Why we need do it?</p>
<p>JdbcMutableAclService and BasicLookupStrategy has issues when query contains the ‘acl_object_identity.object_id_identity’ in DB table. If we use ‘varchar’ as the type of this field, following exception will always be thrown. so, we <strong>MUST</strong> override it.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">org.postgresql.util.PSQLException: ERROR: operator does not exist: bigint &#x3D; character varying</span><br><span class="line">  Hint: No operator matches the given name and argument types. You might need to add explicit type casts.</span><br><span class="line">  Position: 190</span><br><span class="line">	at org.postgresql.core.v3.QueryExecutorImpl.receiveErrorResponse(QueryExecutorImpl.java:2533) ~[postgresql-42.2.12.jar:42.2.12]</span><br><span class="line">	at org.postgresql.core.v3.QueryExecutorImpl.processResults(QueryExecutorImpl.java:2268) ~[postgresql-42.2.12.jar:42.2.12]</span><br><span class="line">	at org.postgresql.core.v3.QueryExecutorImpl.execute(QueryExecutorImpl.java:313) ~[postgresql-42.2.12.jar:42.2.12]</span><br><span class="line">	at org.postgresql.jdbc.PgStatement.executeInternal(PgStatement.java:448) ~[postgresql-42.2.12.jar:42.2.12]</span><br><span class="line">	at org.postgresql.jdbc.PgStatement.execute(PgStatement.java:369) ~[postgresql-42.2.12.jar:42.2.12]</span><br><span class="line">	at org.postgresql.jdbc.PgPreparedStatement.executeWithFlags(PgPreparedStatement.java:159) ~[postgresql-42.2.12.jar:42.2.12]</span><br><span class="line">	at org.postgresql.jdbc.PgPreparedStatement.executeQuery(PgPreparedStatement.java:109) ~[postgresql-42.2.12.jar:42.2.12]</span><br><span class="line">	at com.zaxxer.hikari.pool.ProxyPreparedStatement.executeQuery(ProxyPreparedStatement.java:52) ~[HikariCP-3.4.3.jar:na]</span><br><span class="line">	at com.zaxxer.hikari.pool.HikariProxyPreparedStatement.executeQuery(HikariProxyPreparedStatement.java) ~[HikariCP-3.4.3.jar:na]</span><br><span class="line">	at org.springframework.jdbc.core.JdbcTemplate$1.doInPreparedStatement(JdbcTemplate.java:678) ~[spring-jdbc-5.2.6.RELEASE.jar:5.2.6.RELEASE]</span><br><span class="line">	at org.springframework.jdbc.core.JdbcTemplate.execute(JdbcTemplate.java:617) ~[spring-jdbc-5.2.6.RELEASE.jar:5.2.6.RELEASE]</span><br><span class="line">	at org.springframework.jdbc.core.JdbcTemplate.query(JdbcTemplate.java:669) ~[spring-jdbc-5.2.6.RELEASE.jar:5.2.6.RELEASE]</span><br><span class="line">	at org.springframework.jdbc.core.JdbcTemplate.query(JdbcTemplate.java:700) ~[spring-jdbc-5.2.6.RELEASE.jar:5.2.6.RELEASE]</span><br><span class="line">	at org.springframework.jdbc.core.JdbcTemplate.query(JdbcTemplate.java:712) ~[spring-jdbc-5.2.6.RELEASE.jar:5.2.6.RELEASE]</span><br><span class="line">	at org.springframework.jdbc.core.JdbcTemplate.queryForObject(JdbcTemplate.java:783) ~[spring-jdbc-5.2.6.RELEASE.jar:5.2.6.RELEASE]</span><br><span class="line">	at org.springframework.jdbc.core.JdbcTemplate.queryForObject(JdbcTemplate.java:809) ~[spring-jdbc-5.2.6.RELEASE.jar:5.2.6.RELEASE]</span><br><span class="line">	at org.springframework.security.acls.jdbc.JdbcMutableAclService.retrieveObjectIdentityPrimaryKey(JdbcMutableAclService.java:341) ~[spring-security-acl-5.2.4.RELEASE.jar:5.2.4.RELEASE]</span><br><span class="line">	at org.springframework.security.acls.jdbc.JdbcMutableAclService.createAcl(JdbcMutableAclService.java:107) ~[spring-security-acl-5.2.4.RELEASE.jar:5.2.4.RELEASE]</span><br><span class="line">	at com.simplejourney.securityacl.controllers.NoteController.save(NoteController.java:66) ~[classes&#x2F;:na]</span><br><span class="line">	at com.simplejourney.securityacl.controllers.NoteController$$FastClassBySpringCGLIB$$d4cbf884.invoke(&lt;generated&gt;) ~[classes&#x2F;:na]</span><br><span class="line">	at org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:218) ~[spring-core-5.2.6.RELEASE.jar:5.2.6.RELEASE]</span><br><span class="line">	...</span><br></pre></td></tr></table></figure>
<p>About the details of issue, please refer to <a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-security/issues/5508">Spring Security ACL: No operator matches the given name and argument type #5508</a></p>
<p><strong>DemoAclPermissionEvaluator.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityacl.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.access.PermissionEvaluator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.acls.domain.DefaultPermissionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.acls.domain.ObjectIdentityRetrievalStrategyImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.acls.domain.PermissionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.acls.domain.SidRetrievalStrategyImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.acls.model.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * If we want to make the data which has not ACL can be visited by any users,</span></span><br><span class="line"><span class="comment"> * we need override this interface</span></span><br><span class="line"><span class="comment"> * &#x27;hasPermission&#x27; of PermissionEvaluator will be called before &#x27;isGranted&#x27; of PermissionGrantingStrategy</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoAclPermissionEvaluator</span> <span class="keyword">implements</span> <span class="title">PermissionEvaluator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AclService aclService;</span><br><span class="line">    <span class="keyword">private</span> ObjectIdentityRetrievalStrategy objectIdentityRetrievalStrategy = <span class="keyword">new</span> ObjectIdentityRetrievalStrategyImpl();</span><br><span class="line">    <span class="keyword">private</span> ObjectIdentityGenerator objectIdentityGenerator = <span class="keyword">new</span> ObjectIdentityRetrievalStrategyImpl();</span><br><span class="line">    <span class="keyword">private</span> SidRetrievalStrategy sidRetrievalStrategy = <span class="keyword">new</span> SidRetrievalStrategyImpl();</span><br><span class="line">    <span class="keyword">private</span> PermissionFactory permissionFactory = <span class="keyword">new</span> DefaultPermissionFactory();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DemoAclPermissionEvaluator</span><span class="params">(AclService aclService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.aclService = aclService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPermissionFactory</span><span class="params">(PermissionFactory permissionFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.permissionFactory = permissionFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasPermission</span><span class="params">(Authentication authentication, Object domainObject, Object permission)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (domainObject == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ObjectIdentity objectIdentity = <span class="keyword">this</span>.objectIdentityRetrievalStrategy.getObjectIdentity(domainObject);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.checkPermission(authentication, objectIdentity, permission);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasPermission</span><span class="params">(Authentication authentication, Serializable targetId, String targetType, Object permission)</span> </span>&#123;</span><br><span class="line">        ObjectIdentity objectIdentity = <span class="keyword">this</span>.objectIdentityGenerator.createObjectIdentity(targetId, targetType);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.checkPermission(authentication, objectIdentity, permission);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkPermission</span><span class="params">(Authentication authentication, ObjectIdentity oid, Object permission)</span> </span>&#123;</span><br><span class="line">        List&lt;Sid&gt; sids = <span class="keyword">this</span>.sidRetrievalStrategy.getSids(authentication);</span><br><span class="line">        List&lt;Permission&gt; requiredPermission = <span class="keyword">this</span>.resolvePermission(permission);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Acl acl = <span class="keyword">this</span>.aclService.readAclById(oid, sids);</span><br><span class="line">            <span class="keyword">if</span> (acl.isGranted(requiredPermission, sids, <span class="keyword">false</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NotFoundException var8) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * There is not acl data for object,</span></span><br><span class="line"><span class="comment">             * Return true, if data should be public for all visitors;</span></span><br><span class="line"><span class="comment">             * otherwise, false</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;Permission&gt; <span class="title">resolvePermission</span><span class="params">(Object permission)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (permission <span class="keyword">instanceof</span> Integer) &#123;</span><br><span class="line">            <span class="keyword">return</span> Arrays.asList(<span class="keyword">this</span>.permissionFactory.buildFromMask((Integer)permission));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (permission <span class="keyword">instanceof</span> Permission) &#123;</span><br><span class="line">            <span class="keyword">return</span> Arrays.asList((Permission)permission);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (permission <span class="keyword">instanceof</span> Permission[]) &#123;</span><br><span class="line">            <span class="keyword">return</span> Arrays.asList((Permission[])((Permission[])permission));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (permission <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">                String permString = (String)permission;</span><br><span class="line"></span><br><span class="line">                Permission p;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    p = <span class="keyword">this</span>.permissionFactory.buildFromName(permString);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IllegalArgumentException var5) &#123;</span><br><span class="line">                    p = <span class="keyword">this</span>.permissionFactory.buildFromName(permString.toUpperCase(Locale.ENGLISH));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> Arrays.asList(p);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unsupported permission: &quot;</span> + permission);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The ‘hasPermission’ method will be called firstly when authorizing data access of user. You may found there only few changes with the code of ‘AclPermissionEvaluator’ since we hope the data which has not the ACL object can be accessed by all users. By default, if you use ‘AclPermissionEvaluator’, it will be refused. </p>
<p><strong>DemoPermissionGrantingStrategy.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityacl.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityacl.common.Constants;</span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityacl.entities.UserGroup;</span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityacl.repositories.UserGroupRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.acls.domain.GrantedAuthoritySid;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.acls.domain.PrincipalSid;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.acls.model.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoPermissionGrantingStrategy</span> <span class="keyword">implements</span> <span class="title">PermissionGrantingStrategy</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserGroupRepository userGroupRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isGranted</span><span class="params">(Acl acl, List&lt;Permission&gt; permissions, List&lt;Sid&gt; sids, <span class="keyword">boolean</span> b)</span> </span>&#123;</span><br><span class="line">        String username = ((PrincipalSid)sids.get(<span class="number">0</span>)).getPrincipal();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">1</span>; index &lt; sids.size(); index++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (GrantedAuthoritySid.class.isAssignableFrom(sids.get(index).getClass())) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;ADMIN&quot;</span>.equals(((GrantedAuthoritySid) sids.get(index)).getGrantedAuthority())) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// check user is owner or not</span></span><br><span class="line">        String owner_name = ((PrincipalSid)acl.getOwner()).getPrincipal();</span><br><span class="line">        <span class="keyword">if</span> (username.equals(owner_name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// check aces</span></span><br><span class="line">        <span class="keyword">int</span> authorizedPermission = <span class="number">0</span>;</span><br><span class="line">        List&lt;AccessControlEntry&gt; aces = acl.getEntries();</span><br><span class="line">        <span class="keyword">for</span> (AccessControlEntry ace : aces) &#123;</span><br><span class="line">            Sid sid = ace.getSid();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (PrincipalSid.class.isAssignableFrom(sid.getClass())) &#123;</span><br><span class="line">                <span class="keyword">if</span> (((PrincipalSid)sid).getPrincipal().startsWith(Constants.USER_SID_PREFIX)) &#123; <span class="comment">// user</span></span><br><span class="line">                    String authorized_user_name = ((PrincipalSid)sid).getPrincipal().substring(<span class="number">2</span>);</span><br><span class="line">                    <span class="keyword">if</span> (authorized_user_name.equals(username)) &#123;</span><br><span class="line">                        authorizedPermission |= ace.getPermission().getMask();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (((PrincipalSid)sid).getPrincipal().startsWith(Constants.GROUP_SID_PREFIX)) &#123; <span class="comment">// group</span></span><br><span class="line">                    String authorized_group_name = ((PrincipalSid)sid).getPrincipal().substring(<span class="number">2</span>);</span><br><span class="line">                    List&lt;UserGroup&gt; userGroups = userGroupRepository.findUserGroupByUserIsAndGroupIs(username, authorized_group_name);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">null</span> != userGroups) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (UserGroup ugr : userGroups) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (ugr.getUser().getName().equals(username)) &#123;</span><br><span class="line">                                authorizedPermission |= ace.getPermission().getMask();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (((PrincipalSid)sid).getPrincipal().equals(Constants.OTHERS_SID_NAME)) &#123; <span class="comment">// public</span></span><br><span class="line">                    authorizedPermission |= ace.getPermission().getMask();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> checkPermission(permissions, authorizedPermission);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkPermission</span><span class="params">(List&lt;Permission&gt; permissions, <span class="keyword">int</span> mask)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Permission permission : permissions) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0</span> != (mask &amp; permission.getMask())) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>When ‘PermissionEvaluator’ call ‘isGranted’ method of ACL, it will call here to complete the permission checking and granting. It is major position which implementing our customizing policies.</p>
<p><strong>DemoBasePermission.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityacl.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.acls.domain.BasePermission;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoBasePermission</span> <span class="keyword">extends</span> <span class="title">BasePermission</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DemoBasePermission</span><span class="params">(<span class="keyword">int</span> mask)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(mask);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Extends the ‘BasePermission’ here, we only want to provide ability to create combined permission. With default, we only can assign one of permissions to an ACE. But we want combined permission in it. Such as, if an user has READ and WRITE permission on a data, we should set ‘Permission.READ | Permission.WRITE’ in ACE.</p>
<h4 id="Business-Logic"><a href="#Business-Logic" class="headerlink" title="Business Logic"></a>Business Logic</h4><p>Ok, the ACL has been provided, let’s start to implement our business.</p>
<p>First, we need provide some APIs to make user can access nodes. With our requirements, we should have</p>
<ul>
<li>Creates note: POST requirement</li>
<li>Deletes note: DELETE requirement</li>
<li>Updates note: PUT requirement</li>
<li>Query notes list: GET requirement</li>
<li>Query details of note: GET requirement</li>
<li>Share note: POST requirement</li>
</ul>
<p><strong>NoteController.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityacl.controllers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityacl.common.Constants;</span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityacl.config.DemoBasePermission;</span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityacl.dto.NoteDTO;</span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityacl.dto.ShareSettingDTO;</span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityacl.entities.Group;</span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityacl.entities.ShareSetting;</span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityacl.entities.User;</span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityacl.repositories.GroupRepository;</span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityacl.repositories.UserRepositoy;</span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityacl.services.NoteService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.acls.domain.PrincipalSid;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(value = &quot;/note&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NoteController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> NoteService noteService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepositoy userRepositoy;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GroupRepository groupRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;NoteDTO&gt; <span class="title">save</span><span class="params">(<span class="meta">@RequestBody</span> NoteDTO noteDTO)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(noteService.save(noteDTO));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;NoteDTO&gt; <span class="title">edit</span><span class="params">(<span class="meta">@RequestBody</span> NoteDTO noteDTO)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(noteService.edit(noteDTO));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DeleteMapping(value = &quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity <span class="title">remove</span><span class="params">(<span class="meta">@PathVariable</span> <span class="keyword">long</span> id)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        noteService.remove(id);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;List&lt;NoteDTO&gt;&gt; list() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(noteService.list());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;NoteDTO&gt; <span class="title">get</span><span class="params">(<span class="meta">@PathVariable</span> <span class="keyword">long</span> id)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(noteService.getById(id));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;/&#123;id&#125;/share&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity <span class="title">share</span><span class="params">(<span class="meta">@PathVariable</span> <span class="keyword">long</span> id, <span class="meta">@RequestBody</span> List&lt;ShareSettingDTO&gt; settings)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        List&lt;ShareSetting&gt; shareSettings = settings.stream().map((ShareSettingDTO dto) -&gt; &#123;</span><br><span class="line">            ShareSetting ss = <span class="keyword">new</span> ShareSetting();</span><br><span class="line">            ss.setPermissions(<span class="keyword">new</span> DemoBasePermission(dto.getPermissions()));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (dto.getEntityType()) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0</span>: <span class="comment">// user</span></span><br><span class="line">                    Optional&lt;User&gt; user = userRepositoy.findById(dto.getEntityId());</span><br><span class="line">                    <span class="keyword">if</span> (user.isPresent()) &#123;</span><br><span class="line">                        ss.setSid(<span class="keyword">new</span> PrincipalSid(Constants.USER_SID_PREFIX + user.get().getName()));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>: <span class="comment">// group</span></span><br><span class="line">                    Optional&lt;Group&gt; group = groupRepository.findById(dto.getEntityId());</span><br><span class="line">                    <span class="keyword">if</span> (group.isPresent()) &#123;</span><br><span class="line">                        ss.setSid(<span class="keyword">new</span> PrincipalSid(Constants.GROUP_SID_PREFIX + group.get().getName()));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    ss.setSid(<span class="keyword">new</span> PrincipalSid(Constants.OTHERS_SID_NAME));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ss;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (noteService.share(id, shareSettings)) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.ok().build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity(HttpStatus.BAD_REQUEST);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>When a note is created, we should add an ACL for it. it will mark the owner of the note. Otherwise, the note will be public for all users. And also, you can remove ‘DemoAclPermissionEvaluator’ and use built-in ‘AclPermissionEvaluator’ to make note private by default.</p>
<p>When a note is deleted, we also need remove related ACL at same time.</p>
<p>The ‘share’ api will apply a list of sharing settings, and an ACE will be created for each of them and add to ACL object. If we don’t want continue to share a note, we just need remove the ACE(s).</p>
<p><strong>NoteService.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityacl.services;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityacl.dto.NoteDTO;</span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityacl.entities.ShareSetting;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">NoteService</span> </span>&#123;</span><br><span class="line">    <span class="function">NoteDTO <span class="title">save</span><span class="params">(NoteDTO noteDTO)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">    <span class="function">NoteDTO <span class="title">edit</span><span class="params">(NoteDTO noteDTO)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">long</span> id)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">    <span class="function">List&lt;NoteDTO&gt; <span class="title">list</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">    <span class="function">NoteDTO <span class="title">getById</span><span class="params">(<span class="keyword">long</span> id)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">share</span><span class="params">(Long noteId, List&lt;ShareSetting&gt; settings)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>NoteServiceImpl.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityacl.services.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityacl.utils.AuthUtil;</span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityacl.dto.NoteDTO;</span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityacl.entities.ShareSetting;</span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityacl.entities.Note;</span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityacl.entities.User;</span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityacl.repositories.NoteRepository;</span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityacl.services.NoteService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.access.prepost.PostFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.access.prepost.PreAuthorize;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.acls.domain.ObjectIdentityImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.acls.model.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.HttpServerErrorException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.transaction.Transactional;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NoteServiceImpl</span> <span class="keyword">implements</span> <span class="title">NoteService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AclService aclService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> NoteRepository noteRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthUtil authUtil;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NoteDTO <span class="title">save</span><span class="params">(NoteDTO noteDTO)</span> </span>&#123;</span><br><span class="line">        User userEntity = authUtil.getUserEntity();</span><br><span class="line"></span><br><span class="line">        Note note = noteDTO.toNote();</span><br><span class="line">        note.setAuthorId(userEntity.getId());</span><br><span class="line">        note.setCreateDate(System.currentTimeMillis());</span><br><span class="line"></span><br><span class="line">        Note saved = noteRepository.save(note);</span><br><span class="line"></span><br><span class="line">        ObjectIdentity oi = <span class="keyword">new</span> ObjectIdentityImpl(Note.class, saved.getId());</span><br><span class="line">        MutableAcl acl = ((MutableAclService) aclService).createAcl(oi);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NoteDTO.from(saved);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasPermission(#noteDTO.id, &#x27;com.simplejourney.securityacl.entities.Note&#x27;, 1) and hasPermission(#noteDTO.id, &#x27;com.simplejourney.securityacl.entities.Note&#x27;, 2)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NoteDTO <span class="title">edit</span><span class="params">(NoteDTO noteDTO)</span> </span>&#123;</span><br><span class="line">        Optional&lt;Note&gt; exists = noteRepository.findById(noteDTO.getId());</span><br><span class="line">        <span class="keyword">if</span> (!exists.isPresent()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> HttpServerErrorException(HttpStatus.NOT_FOUND);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Note saved = noteRepository.save(noteDTO.toNote());</span><br><span class="line">        <span class="keyword">return</span> NoteDTO.from(saved);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasPermission(#id, &#x27;com.simplejourney.securityacl.entities.Note&#x27;, 8)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">        noteRepository.deleteById(id);</span><br><span class="line">        <span class="keyword">this</span>.removeACL(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostFilter(&quot;hasPermission(filterObject.id, &#x27;com.simplejourney.securityacl.entities.Note&#x27;, 1)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;NoteDTO&gt; <span class="title">list</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Iterable&lt;Note&gt; noteIterable = noteRepository.findAll();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == noteIterable) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> HttpServerErrorException(HttpStatus.NOT_FOUND);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Iterator&lt;Note&gt; iterator = noteIterable.iterator();</span><br><span class="line">        <span class="keyword">if</span> (!iterator.hasNext()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> HttpServerErrorException(HttpStatus.NOT_FOUND);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;NoteDTO&gt; noteDTOS = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            noteDTOS.add(NoteDTO.from(iterator.next()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> noteDTOS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasPermission(#id, &#x27;com.simplejourney.securityacl.entities.Note&#x27;, 1)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NoteDTO <span class="title">getById</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">        Optional&lt;Note&gt; note = noteRepository.findById(id);</span><br><span class="line">        <span class="keyword">if</span> (!note.isPresent()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> HttpServerErrorException(HttpStatus.NOT_FOUND);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> NoteDTO.from(note.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasPermission(#noteId, &#x27;com.simplejourney.securityacl.entities.Note&#x27;, 4)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">share</span><span class="params">(Long noteId, List&lt;ShareSetting&gt; settings)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == settings || settings.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ObjectIdentity oi = <span class="keyword">new</span> ObjectIdentityImpl(Note.class, noteId);</span><br><span class="line">        MutableAcl acl = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            acl = (MutableAcl) aclService.readAclById(oi);</span><br><span class="line">            <span class="keyword">if</span> (acl != <span class="keyword">null</span>) &#123;</span><br><span class="line">                clearACEs(acl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NotFoundException ex)&#123;</span><br><span class="line">            acl = ((MutableAclService) aclService).createAcl(oi);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (ShareSetting setting : settings) &#123;</span><br><span class="line">            acl.insertAce(acl.getEntries().size(), setting.getPermissions(), setting.getSid(), <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ((MutableAclService) aclService).updateAcl(acl);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeACL</span><span class="params">(<span class="keyword">long</span> noteId)</span> </span>&#123;</span><br><span class="line">        ObjectIdentity oi = <span class="keyword">new</span> ObjectIdentityImpl(Note.class, noteId);</span><br><span class="line">        ((MutableAclService) aclService).deleteAcl(oi, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearACEs</span><span class="params">(MutableAcl acl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> count = acl.getEntries().size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> index = count - <span class="number">1</span>; index &gt;= <span class="number">0</span>; index++) &#123;</span><br><span class="line">                acl.deleteAce(index);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NotFoundException ex) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The real jobs of data accessing are done here. To use ACL mechanism, we need add annotation and expression for each method to indicate what permission are needed on these data.</p>
<p>For all annotations and expressions, please refer to <a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/site/docs/current/reference/html5/#el-access">Spring Security Reference: 11.3. Expression-Based Access Control</a>.</p>
<p>Notice, when we operate the ACL data, transaction is needed.</p>
<h3 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h3><p>OK, all things done. We can test our application now.</p>
<h4 id="Add-SwaggerUI-Support"><a href="#Add-SwaggerUI-Support" class="headerlink" title="Add SwaggerUI Support"></a>Add SwaggerUI Support</h4><p>Add following code in ‘SwaggerUI.java’ in same package as ‘DemoApplication.java’, we can easy to use swagger ui to test all APIs in a web page.</p>
<p><strong>SwaggerUI.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityacl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.ApiInfoBuilder;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.ParameterBuilder;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.PathSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.RequestHandlerSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.schema.ModelRef;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.ApiInfo;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.Parameter;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spi.DocumentationType;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spring.web.plugins.Docket;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.swagger2.annotations.EnableSwagger2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger2</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SwaggerUI</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Docket <span class="title">createRestApi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ParameterBuilder tokenPar = <span class="keyword">new</span> ParameterBuilder();</span><br><span class="line">        List&lt;Parameter&gt; pars = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        tokenPar.name(<span class="string">&quot;Authorization&quot;</span>).description(<span class="string">&quot;Token&quot;</span>).modelRef(<span class="keyword">new</span> ModelRef(<span class="string">&quot;string&quot;</span>)).parameterType(<span class="string">&quot;header&quot;</span>).required(<span class="keyword">false</span>).build();</span><br><span class="line">        pars.add(tokenPar.build());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Docket(DocumentationType.SWAGGER_2)</span><br><span class="line">                .select()</span><br><span class="line">                .apis(RequestHandlerSelectors.basePackage(<span class="string">&quot;com.simplejourney.securityacl.controllers&quot;</span>))</span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build()</span><br><span class="line">                .globalOperationParameters(pars)</span><br><span class="line">                .apiInfo(apiInfo());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ApiInfo <span class="title">apiInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ApiInfoBuilder().title(<span class="string">&quot;Simple APIs&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;simple apis&quot;</span>)</span><br><span class="line">                .version(<span class="string">&quot;1.0&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="swagger-ui.png"></p>
<p>About how to use Swagger UI, you can refer to previous posts, or access <a target="_blank" rel="noopener" href="https://swagger.io/tools/swagger-ui/">Offical Site</a> of it to find more.</p>
<h4 id="Test-Cases"><a href="#Test-Cases" class="headerlink" title="Test Cases"></a>Test Cases</h4><h5 id="Case-1"><a href="#Case-1" class="headerlink" title="Case 1:"></a>Case 1:</h5><p>Tom create 1 note should be successful.</p>
<p>Tom update the content of it should be successful.</p>
<p>Tom can get note list which contains this note.</p>
<p>Tom can get details of this note.</p>
<p>Tom can delete this note.</p>
<p>Jerry, Nibbles and Spike cannot access this note.</p>
<h5 id="Case-2"><a href="#Case-2" class="headerlink" title="Case 2:"></a>Case 2:</h5><p>Tom create 1 note should be successful.</p>
<p>Tom share this note with READ permission to family should be successful.</p>
<p>Jerry can get note list which contains this note.</p>
<p>Jerry can get details of this note.</p>
<p>Jerry cannot update and delete this note.</p>
<p>Nibbles and Spike cannot access this note.</p>
<h5 id="Case-3"><a href="#Case-3" class="headerlink" title="Case 3:"></a>Case 3:</h5><p>Tom create 1 note should be successful.</p>
<p>Tom share this note with READ permission to public should be successful.</p>
<p>Jerry, Nibbles and Spike can get note list which contains this note.</p>
<p>Jerry, Nibbles and Spike can get details of this note.</p>
<p>Jerry, Nibbles and Spike cannot update and delete this note.</p>
<h5 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h5><p>There are more test cases to test our application, I will not show all of them here. If you are interested in this demo, you can think and try them.</p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>OK, the service work well now.</p>
<p>If you have any questions or suggestions, please feel free to submit your comments to <a target="_blank" rel="noopener" href="https://github.com/xpw-osr/xpw-osr.github.io/issues/7">issue</a>.</p>
<p>The demo projects you can download from Github with following links</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/xpw-osr/blog-examples/tree/master/Spring%20Boot/security-acl">security-acl</a></li>
</ul>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/site/docs/current/reference/html5/#el-access">Spring Security Reference: 11.3. Expression-Based Access Control</a><br><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-security/site/docs/current/reference/html5/#dbschema-acl">Spring Security Reference: 22.3 ACL Schema</a><br><a target="_blank" rel="noopener" href="https://github.com/spring-projects/spring-security/issues/5508">Spring Security ACL: No operator matches the given name and argument type #5508</a></p>
</div><div class="tags"><a href="/tags/Spring-Boot/"><i class="fa fa-tag"></i>Spring Boot</a><a href="/tags/Spring-Security/"><i class="fa fa-tag"></i>Spring Security</a><a href="/tags/Authentication/"><i class="fa fa-tag"></i>Authentication</a><a href="/tags/Authorization/"><i class="fa fa-tag"></i>Authorization</a></div><div class="post-nav"><a class="next" href="/2020/05/26/spring-security-authentication-and-authoriztion-with-oauth2/">Spring Security: Authentication and Authoriztion with OAuth2</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://xpw-osr.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Boot/">Spring Boot</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tools/">Tools</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/Blog/" style="font-size: 15px;">Blog</a> <a href="/tags/Github/" style="font-size: 15px;">Github</a> <a href="/tags/NVM/" style="font-size: 15px;">NVM</a> <a href="/tags/Node-js/" style="font-size: 15px;">Node.js</a> <a href="/tags/Spring-Boot/" style="font-size: 15px;">Spring Boot</a> <a href="/tags/Spring-Security/" style="font-size: 15px;">Spring Security</a> <a href="/tags/FilterChain/" style="font-size: 15px;">FilterChain</a> <a href="/tags/JWT/" style="font-size: 15px;">JWT</a> <a href="/tags/Authentication/" style="font-size: 15px;">Authentication</a> <a href="/tags/Authorization/" style="font-size: 15px;">Authorization</a> <a href="/tags/OAuth2/" style="font-size: 15px;">OAuth2</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/07/29/spring-security-data-access-authorization-with-acl/">Spring Security: Data Access Authorization with ACL</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/26/spring-security-authentication-and-authoriztion-with-oauth2/">Spring Security: Authentication and Authoriztion with OAuth2</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/13/spring-security-authentication-and-authorization-with-jwt-for-separated-backend/">Spring Security: Authentication and Authorization with JWT for separated backend</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/12/spring-security-how-filter-chain-works/">Spring Security: How Filter Chain works</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/09/spring-security-authentication-and-authorization-for-separated-backend/">Spring Security: Authentication and authorization for separated backend</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/05/hexo-create-blog-on-github/">Hexo: Create Blog on Github</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/05/nvm-manage-multiple-nodejs-versions/">NVM: Manage Multiple Node.js Versions</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">Simple Journey.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>