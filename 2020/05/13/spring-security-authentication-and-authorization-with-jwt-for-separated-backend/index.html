<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>Spring Security: Authentication and Authorization with JWT for separated backend | Simple Journey</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/2.0.4/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/2.1.4/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/2.1.4/toastr.min.css"><meta name="generator" content="Hexo 4.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Spring Security: Authentication and Authorization with JWT for separated backend</h1><a id="logo" href="/.">Simple Journey</a><p class="description">Every Little Helps</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/tags/"><i class="fa fa-tag"> Tags</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Spring Security: Authentication and Authorization with JWT for separated backend</h1><div class="post-meta">2020-05-13<span> | </span><span class="category"><a href="/categories/Spring-Boot/">Spring Boot</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">Contents</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#What-is-JWT"><span class="toc-number">1.</span> <span class="toc-text">What is JWT</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-integrate-with-Spring-Security"><span class="toc-number">2.</span> <span class="toc-text">How to integrate with Spring Security</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Make-Token-Invalid-Immediately"><span class="toc-number">3.</span> <span class="toc-text">Make Token Invalid Immediately</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#References"><span class="toc-number">4.</span> <span class="toc-text">References</span></a></li></ol></div></div><div class="post-content"><p>In post of <a href="https://xpw-osr.github.io/2020/05/09/spring-security-authentication-and-authorization-for-separated-backend/">Spring Security: Authentication and authorization for separated backend</a>, I have show you how to use Spring Security to authenticate and authorize for separated backend of web application. With that way, the server side will store sessions for users, and send cookie to front-end. It means the server side saved the state of user.</p>
<p>In this post, I will show you how to implement Stateless authentication and authorization with Spring Security and JWT.</p>
<h3 id="What-is-JWT"><a href="#What-is-JWT" class="headerlink" title="What is JWT"></a>What is JWT</h3><p>JWT is short for ‘JSON Web Tokens’. It provids a compact, URL-safe way to represent claims when we need transfer them between two parties. It use JSON to encode the claims and make us easy to read/write and produce.</p>
<p>I believe you have find the JWT will not do any things about Authentication, it just encode and decode the claims, then we can transfer it between 2 sides. We need implement the logic to verify the user’s information by ourselves.</p>
<p>Then, why we use it?</p>
<ul>
<li><p>First, it has higher safety to a certain extent. It can prevent the token is falsified.</p>
</li>
<li><p>Second, it is self-contained and stateless. we need not store it on server side in most situations.</p>
</li>
<li><p>Third, it is a cross-language solution. If your application is implemented with Microservice model. It could work well for each service which implemented with different languages.</p>
</li>
<li><p>Forth, it supports token expiring. We can set a expiring time point for it, after that, the token will be invalid.</p>
</li>
</ul>
<p>But there also has some points we need to be careful.</p>
<ul>
<li><p>The JWT body is only be encoded with Base64, it is easy to be decoded. It means anybody can read the content of it if they want.</p>
</li>
<li><p>And also, JWT cannot take many messages in body, it will be too long and spend much time on transferring.</p>
</li>
<li><p>Last, we cannot make a JWT token to invalid state before it expired. It’s means, even if it has been removed from front-end, it still is valid at server side. If somebody copied it, they still can access the interfaces and fetch data from server.</p>
</li>
</ul>
<h3 id="How-to-integrate-with-Spring-Security"><a href="#How-to-integrate-with-Spring-Security" class="headerlink" title="How to integrate with Spring Security"></a>How to integrate with Spring Security</h3><p>Ok, let’s start to discuss how to use it with Spring Security.</p>
<p>First, please see following picture which is shown in previous post.</p>
<p><img src="spring-security-authentication-workflow.png" alt=""></p>
<p>When we discuss how to customize the authentication process in that post, we extended the UsernamePasswordAuthenticationFilter and replaced it in SecurityFilterChain. The same thing is we also want to customize the authentication process by using JWT. The difference is we cannot get the username and password from path variables and body of request directly in Filter. The user’s information will be get after JWT decoded the token. When there is not token, we need call next Filter in SecurityFilterChain. So, we need not ‘form-login’ and only use filter of JWT to complete the job of authentication.</p>
<p>Before we start to write code, let’s see what should we do in JWT filter</p>
<p><img src="jwt-filter-flowchart.png" alt=""></p>
<p>With this flowchart, we can see we just need create UsernamePasswordAuthenticationToken object with user details and authorities, and save it into SecurityContextHolder when token exists. Then just call filterChain.doFilter() method.</p>
<p>With the knowlege of <a href="https://xpw-osr.github.io/2020/05/12/spring-security-how-filter-chain-works/">Spring Security: How Filter Chain works</a>, we can know what are following filters after our customized filter. So, when we call filterChain.doFilter(), it will one by one to execute them until meet the FilterSecurityInterception which will check the authorities and authorize. If passed, the api which requested in request will be called.</p>
<p>Then, do you have know where we should implement the authentication logic? Yes, it should be in API method of controller. And, it must be an API which need not permissions because authorities is null in login request.</p>
<p>OK, let’s start write code.</p>
<p>The first class is an util, we will implement all operations of token in it.</p>
<p>JWTAuthenticationUtil.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityjwt.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Jwts;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.SignatureAlgorithm;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JWTAuthenticationUtil</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Value</span>(<span class="string">"$&#123;jwt.secret&#125;"</span>)</span><br><span class="line">  <span class="keyword">private</span> String secret;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> JWT_TOKEN_VALIDITY = <span class="number">5</span> * <span class="number">60</span> * <span class="number">60</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getClaimFromToken(token, Claims::getSubject);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">generateToken</span><span class="params">(Map&lt;String, Object&gt; claims, UserDetails userDetails)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == claims) &#123;</span><br><span class="line">      claims = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> doGenerateToken(claims, userDetails.getUsername());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Boolean <span class="title">validateToken</span><span class="params">(String token, UserDetails userDetails)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String username =getClaimFromToken(token, Claims::getSubject);</span><br><span class="line">    <span class="keyword">return</span> (username.equals(userDetails.getUsername()) &amp;&amp; !isTokenExpired(token));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Boolean <span class="title">isTokenExpired</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Date expiration = getClaimFromToken(token, Claims::getExpiration);</span><br><span class="line">    <span class="keyword">return</span> expiration.before(<span class="keyword">new</span> Date());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> &lt;T&gt; <span class="function">T <span class="title">getClaimFromToken</span><span class="params">(String token, Function&lt;Claims, T&gt; claimsResolver)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Claims claims = getAllClaimsFromToken(token);</span><br><span class="line">    <span class="keyword">return</span> claimsResolver.apply(claims);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Claims <span class="title">getAllClaimsFromToken</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Jwts.parser().setSigningKey(secret).parseClaimsJws(token).getBody();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> String <span class="title">doGenerateToken</span><span class="params">(Map&lt;String, Object&gt; claims, String subject)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        iss: issuer</span></span><br><span class="line"><span class="comment">        exp: expiration time</span></span><br><span class="line"><span class="comment">        sub: subject</span></span><br><span class="line"><span class="comment">        aud: audience</span></span><br><span class="line"><span class="comment">        nbf: Not Before</span></span><br><span class="line"><span class="comment">        iat: Issued At</span></span><br><span class="line"><span class="comment">        jti: JWT ID</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    <span class="keyword">return</span> Jwts.builder()</span><br><span class="line">      .setClaims(claims)</span><br><span class="line">      .setSubject(subject)    <span class="comment">// sub</span></span><br><span class="line">      .setIssuedAt(<span class="keyword">new</span> Date(System.currentTimeMillis()))  <span class="comment">// iat</span></span><br><span class="line">      .setExpiration(<span class="keyword">new</span> Date(System.currentTimeMillis() + JWT_TOKEN_VALIDITY * <span class="number">1000</span>))    <span class="comment">// exp</span></span><br><span class="line">      .signWith(SignatureAlgorithm.HS512, secret)</span><br><span class="line">      .compact();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then we can implement filter for JWT</p>
<p>JWTRequestFilter.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityjwt.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityjwt.services.JWTTokenManageService;</span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityjwt.services.impl.UserDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityjwt.utils.JWTAuthenticationUtil;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.JwtException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.WebAuthenticationDetailsSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JWTRequestFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> UserDetailsServiceImpl userDetailService;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> JWTAuthenticationUtil JWTAuthenticationUtil;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> JWTTokenManageService tokenManageService;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    String authorization = httpServletRequest.getHeader(<span class="string">"Authorization"</span>);</span><br><span class="line"></span><br><span class="line">    String username = <span class="keyword">null</span>;</span><br><span class="line">    String token = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != authorization &amp;&amp; authorization.startsWith(<span class="string">"Bearer "</span>)) &#123;</span><br><span class="line">      token = authorization.substring(<span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        username = JWTAuthenticationUtil.getUsername(token);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">        System.err.println(<span class="string">"IllegalArgumentException: "</span>);</span><br><span class="line">        ex.printStackTrace();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (JwtException ex) &#123;</span><br><span class="line">        System.err.println(<span class="string">"JwtException: "</span>);</span><br><span class="line">        ex.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      System.err.println(<span class="string">"Token not found or not start with 'Bearer'"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != username &amp;&amp; <span class="keyword">null</span> == SecurityContextHolder.getContext().getAuthentication()) &#123;</span><br><span class="line">      UserDetails userDetails = <span class="keyword">this</span>.userDetailService.loadUserByUsername(username);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (JWTAuthenticationUtil.validateToken(token, userDetails)) &#123;</span><br><span class="line">        UsernamePasswordAuthenticationToken usernamePasswordAuthenticationToken = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(userDetails, <span class="keyword">null</span>, userDetails.getAuthorities());</span><br><span class="line">        usernamePasswordAuthenticationToken.setDetails(<span class="keyword">new</span> WebAuthenticationDetailsSource().buildDetails(httpServletRequest));</span><br><span class="line">        SecurityContextHolder.getContext().setAuthentication(usernamePasswordAuthenticationToken);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    filterChain.doFilter(httpServletRequest, httpServletResponse);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Add WebSecurityConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityjwt.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityjwt.services.impl.UserDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.http.SessionCreationPolicy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> UserDetailsServiceImpl userDetailsService;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> UserAccessDeniedHandler accessDeniedHandler;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> DemoAuthenticationEntryPoint authenticationEntryPoint;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> JWTRequestFilter requestFilter;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureGlobal</span><span class="params">(AuthenticationManagerBuilder authenticationManagerBuilder)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    authenticationManagerBuilder.userDetailsService(userDetailsService).passwordEncoder(passwordEncoder());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> AuthenticationManager <span class="title">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.authenticationManagerBean();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    http</span><br><span class="line">      <span class="comment">// Disable Cross-Site Request Forgery protection</span></span><br><span class="line">      .csrf().disable()</span><br><span class="line">      <span class="comment">// Enable Cross-Origin Resource Sharing</span></span><br><span class="line">      .cors().disable()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * Resources which need not authorization</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">      .authorizeRequests()</span><br><span class="line">      .antMatchers(<span class="string">"/hello"</span>, <span class="string">"/auth/login"</span>).permitAll()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * Other resources need permissions</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">      .anyRequest().authenticated()</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * Exception Handling</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">      .and().exceptionHandling()</span><br><span class="line">      <span class="comment">// set process when autentication failed</span></span><br><span class="line">      .authenticationEntryPoint(authenticationEntryPoint)</span><br><span class="line">      <span class="comment">// set handler for access denied</span></span><br><span class="line">      .accessDeniedHandler(accessDeniedHandler)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * Session</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">      .and().sessionManagement()</span><br><span class="line">      .sessionCreationPolicy(SessionCreationPolicy.STATELESS);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// add JWT filter before authentication</span></span><br><span class="line">    http.addFilterAt(requestFilter, UsernamePasswordAuthenticationFilter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After above, we need implement authentication in login api.</p>
<p>AuthenticationController.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityjwt.controllers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityjwt.dto.LoginData;</span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityjwt.services.JWTTokenManageService;</span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityjwt.services.impl.UserDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityjwt.utils.JWTAuthenticationUtil;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.BadCredentialsException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.DisabledException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/auth"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthenticationController</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> UserDetailsServiceImpl userDetailsService;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> JWTTokenManageService tokenManageService;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> JWTAuthenticationUtil JWTAuthenticationUtil;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostMapping</span>(<span class="string">"/login"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">login</span><span class="params">(HttpServletRequest request, @RequestBody LoginData data)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.authenticationManager.authenticate(<span class="keyword">new</span> UsernamePasswordAuthenticationToken(data.getUsername(), data.getPassword()));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (DisabledException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"USER_DISABLED"</span>, ex);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (BadCredentialsException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"INVALID_CREDENTIALS"</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> UserDetails userDetails = <span class="keyword">this</span>.userDetailsService.loadUserByUsername(data.getUsername());</span><br><span class="line">    <span class="keyword">final</span> String token = JWTAuthenticationUtil.generateToken(<span class="keyword">null</span>, userDetails);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ResponseEntity.ok(token);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>OK, what we need have been done. We can do something for test. (For more code of project need, please see demo project on <a href="https://github.com/xpw-osr/blog-examples/tree/master/Spring%20Boot/securityjwt" target="_blank" rel="noopener">Github</a>)</p>
<p>For this project, we can use Swagger UI to do testing for APIs.</p>
<p>Add following dependencies to ‘build.gradle’</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="string">'io.springfox:springfox-swagger2:2.4.0'</span></span><br><span class="line">implementation <span class="string">'io.springfox:springfox-swagger-ui:2.4.0'</span></span><br></pre></td></tr></table></figure>

<p>And add SwaggerUI class to same folder as DemoApplication</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityjwt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.ApiInfoBuilder;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.ParameterBuilder;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.PathSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.builders.RequestHandlerSelectors;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.schema.ModelRef;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.ApiInfo;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.service.Parameter;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spi.DocumentationType;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.spring.web.plugins.Docket;</span><br><span class="line"><span class="keyword">import</span> springfox.documentation.swagger2.annotations.EnableSwagger2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger</span>2</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SwaggerUI</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Docket <span class="title">createRestApi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ParameterBuilder tokenPar = <span class="keyword">new</span> ParameterBuilder();</span><br><span class="line">    List&lt;Parameter&gt; pars = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    tokenPar.name(<span class="string">"Authorization"</span>).description(<span class="string">"Token"</span>).modelRef(<span class="keyword">new</span> ModelRef(<span class="string">"string"</span>)).parameterType(<span class="string">"header"</span>).required(<span class="keyword">false</span>).build();</span><br><span class="line">    pars.add(tokenPar.build());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Docket(DocumentationType.SWAGGER_2)</span><br><span class="line">      .select()</span><br><span class="line">      .apis(RequestHandlerSelectors.basePackage(<span class="string">"com.simplejourney.securityjwt.controllers"</span>))</span><br><span class="line">      .paths(PathSelectors.any())</span><br><span class="line">      .build()</span><br><span class="line">      .globalOperationParameters(pars)</span><br><span class="line">      .apiInfo(apiInfo());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> ApiInfo <span class="title">apiInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ApiInfoBuilder().title(<span class="string">"Simple APIs"</span>)</span><br><span class="line">      .description(<span class="string">"simple apis"</span>)</span><br><span class="line">      .version(<span class="string">"1.0"</span>)</span><br><span class="line">      .build();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And add following configurations after ‘authorizeRequests()’ in WebSecurityConfig class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// all Swagger-UI accessing need not authorization</span></span><br><span class="line">.antMatchers(</span><br><span class="line">  <span class="string">"/v2/api-docs"</span>,</span><br><span class="line">  <span class="string">"/swagger-resources"</span>,</span><br><span class="line">  <span class="string">"/swagger-resources/**"</span>,</span><br><span class="line">  <span class="string">"/configuration/ui"</span>,</span><br><span class="line">  <span class="string">"/configuration/security"</span>,</span><br><span class="line">  <span class="string">"/swagger-ui.html/**"</span>,</span><br><span class="line">  <span class="string">"/webjars/**"</span></span><br><span class="line">).permitAll()</span><br></pre></td></tr></table></figure>
<p>Then launch application, open web browser which you like and enter url</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;swagger-ui.html</span><br></pre></td></tr></table></figure>

<p>You can see the page looks like following</p>
<p><img src="swagger-ui.png" alt=""></p>
<p>Now, expand ‘POST /auth/login’ pane and enter the username and password to ‘data’, and click ‘Try it out!’ button</p>
<p><img src="swagger-ui-login.png" alt=""></p>
<p>If succeed, you can find the token in ‘Response Body’ section as following</p>
<p><img src="swagger-ui-login-succeed.png" alt=""></p>
<p>This just a example for using Swagger UI, for other APIs, you can test them by yourself.</p>
<h3 id="Make-Token-Invalid-Immediately"><a href="#Make-Token-Invalid-Immediately" class="headerlink" title="Make Token Invalid Immediately"></a>Make Token Invalid Immediately</h3><p>In <a href="#what-is-jwt">What is JWT</a> section, we have know there are some points need to be careful when using JWT. One of them is JWT token cannot be invalid before it expired. </p>
<p>We can try it with Swagger UI of project with following case.</p>
<ul>
<li>Step 1: Login with tom, and copy the token from response</li>
<li>Step 2: Logout </li>
<li>Step 3: Set ‘Authorization’ to ‘Bearer ‘ + ‘you copied token’ to ‘Get /book’ api, and send it</li>
</ul>
<p>You will find you also can receive the book list.</p>
<p>But we may meet the requirements which we should make it invalid immediately. Such as we need kick user offline immediately. Then, how to make it true?</p>
<p>To do this, there is a solution is that we can use Ridis or database to cache an identifier and manage them. When a token is generated, we put the identifier to cache, and when it invalid or we need make it invalid, remove it from cache.</p>
<p>The next question is, how to generate the identifier? There are 2 data we can used.</p>
<p>The first is user’s IP address. To get it, we need add</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br></pre></td></tr></table></figure>

<p>to NGINX,</p>
<p>And/Or</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RequestHeader set X-Forwarded-Proto &quot;http&quot;</span><br></pre></td></tr></table></figure>

<p>for Apache.</p>
<p>Then, we can get it from request by</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.getHeader(<span class="string">"X-FORWARDED-FOR"</span>)</span><br></pre></td></tr></table></figure>

<p>The second is ‘User-Agent’. It also exists in request headers.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.getHeader(<span class="string">"User-Agent"</span>)</span><br></pre></td></tr></table></figure>

<p>And also, we can use both of them. </p>
<p>In my example, I use both of them and encoded with Base64. You also can encode them with MD5 or other hash algorithms.</p>
<p>Then we start to modify our code to add this solution.</p>
<p>First, we need create a service to manage identifiers in cache. In this post, we also use memory as cache.</p>
<p>JWTTokenManageService.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityjwt.services;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JWTTokenManageService</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(String ident, Object token)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(String ident)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">has</span><span class="params">(String ident)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JWTTokenManageServiceImpl.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityjwt.services.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityjwt.services.JWTTokenManageService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JWTTokenManageServiceImpl</span> <span class="keyword">implements</span> <span class="title">JWTTokenManageService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> Map&lt;String, Object&gt; tokens = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(String ident, Object token)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.tokens.put(ident, token);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(String ident)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.tokens.remove(ident);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">has</span><span class="params">(String ident)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.tokens.containsKey(ident);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then we need add code to generate the identifier. So we add following methods in JWTAuthenticationUtil</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">generateIdent</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">  String identSource = String.format(<span class="string">"%s;%s"</span>, getIPAddress(request), getUserAgent(request));</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> String(Base64.getEncoder().encode(identSource.getBytes()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getIdent</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Claims claims = getAllClaimsFromToken(token);</span><br><span class="line">  <span class="keyword">return</span> String.valueOf(claims.get(<span class="string">"ident"</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getIPAddress</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">  String ip = <span class="string">""</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">null</span> != request) &#123;</span><br><span class="line">    ip = request.getHeader(<span class="string">"X-FORWARDED-FOR"</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == ip || ip.isEmpty()) &#123;</span><br><span class="line">      ip = request.getRemoteAddr();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ip;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getUserAgent</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">  String userAgent = <span class="string">""</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">null</span> != request) &#123;</span><br><span class="line">    userAgent = request.getHeader(<span class="string">"User-Agent"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> userAgent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After that, we need modify the ‘login’ API to add the identifier to cache when the token is created</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/login"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">login</span><span class="params">(HttpServletRequest request, @RequestBody LoginData data)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.authenticationManager.authenticate(<span class="keyword">new</span> UsernamePasswordAuthenticationToken(data.getUsername(), data.getPassword()));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (DisabledException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"USER_DISABLED"</span>, ex);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (BadCredentialsException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"INVALID_CREDENTIALS"</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  String ident = jwtAuthenticationUtil.generateIdent(request);</span><br><span class="line">  <span class="keyword">if</span> (!tokenManageService.has(ident)) &#123;</span><br><span class="line">    Map&lt;String, Object&gt; claims = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    claims.put(<span class="string">"ident"</span>, ident);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> UserDetails userDetails = <span class="keyword">this</span>.userDetailsService.loadUserByUsername(data.getUsername());</span><br><span class="line">    <span class="keyword">final</span> String token = jwtAuthenticationUtil.generateToken(claims, userDetails);</span><br><span class="line"></span><br><span class="line">    tokenManageService.add(ident, token);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ResponseEntity.ok(token);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(<span class="keyword">null</span>, HttpStatus.CONFLICT);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And add logout API to remove it from cache when user logout</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/logout"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">logout</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">  String ident = jwtAuthenticationUtil.generateIdent(request);</span><br><span class="line">  <span class="keyword">if</span> (tokenManageService.has(ident)) &#123;</span><br><span class="line">    tokenManageService.remove(ident);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ResponseEntity.ok(<span class="string">"Logout Succeed"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>modify ‘doFilterInternal’ method of JWTRequestFilter to remove it when token is expired</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">  String authorization = httpServletRequest.getHeader(<span class="string">"Authorization"</span>);</span><br><span class="line"></span><br><span class="line">  String username = <span class="keyword">null</span>;</span><br><span class="line">  String token = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">null</span> != authorization &amp;&amp; authorization.startsWith(<span class="string">"Bearer "</span>)) &#123;</span><br><span class="line">    token = authorization.substring(<span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      username = jwtAuthenticationUtil.getUsername(token);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">      System.err.println(<span class="string">"IllegalArgumentException: "</span>);</span><br><span class="line">      ex.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (JwtException ex) &#123;</span><br><span class="line">      System.err.println(<span class="string">"JwtException: "</span>);</span><br><span class="line">      ex.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    System.err.println(<span class="string">"Token not found or not start with 'Bearer'"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  String ident = jwtAuthenticationUtil.generateIdent(httpServletRequest);</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">null</span> != username) &#123;</span><br><span class="line">    Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">    <span class="keyword">boolean</span> hasIdent = tokenManageService.has(ident);</span><br><span class="line">    <span class="keyword">if</span> (hasIdent &amp;&amp; <span class="keyword">null</span> == authentication) &#123;</span><br><span class="line">      UserDetails userDetails = <span class="keyword">this</span>.userDetailService.loadUserByUsername(username);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (jwtAuthenticationUtil.isTokenExpired(token)) &#123;</span><br><span class="line">        tokenManageService.remove(ident);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (ident.equals(jwtAuthenticationUtil.getIdent(token)) &amp;&amp; jwtAuthenticationUtil.validateToken(token, userDetails)) &#123;</span><br><span class="line">        UsernamePasswordAuthenticationToken usernamePasswordAuthenticationToken = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(userDetails, <span class="keyword">null</span>, userDetails.getAuthorities());</span><br><span class="line">        usernamePasswordAuthenticationToken.setDetails(<span class="keyword">new</span> WebAuthenticationDetailsSource().buildDetails(httpServletRequest));</span><br><span class="line">        SecurityContextHolder.getContext().setAuthentication(usernamePasswordAuthenticationToken);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  filterChain.doFilter(httpServletRequest, httpServletResponse);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Done, build and re-launch application and try above test case again. The response after logout should be </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"timestamp"</span>: <span class="string">"2020-05-15T05:53:51.257+0000"</span>,</span><br><span class="line">  <span class="attr">"status"</span>: <span class="number">401</span>,</span><br><span class="line">  <span class="attr">"error"</span>: <span class="string">"Unauthorized"</span>,</span><br><span class="line">  <span class="attr">"message"</span>: <span class="string">"Unauthorized"</span>,</span><br><span class="line">  <span class="attr">"path"</span>: <span class="string">"/book"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>OK, all above are what I want to tell you in this post. If you have any questions or suggestions, please feel free to submit your comments to <a href="https://github.com/xpw-osr/xpw-osr.github.io/issues/5" target="_blank" rel="noopener">issue</a></p>
<p>The demo project you can download from <a href="https://github.com/xpw-osr/blog-examples/tree/master/Spring%20Boot/securityjwt" target="_blank" rel="noopener">Github</a></p>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><ul>
<li><p><a href="https://jwt.io/" target="_blank" rel="noopener">JSON Web Tokens - jwt.io</a></p>
</li>
<li><p><a href="https://swagger.io/tools/swagger-ui/" target="_blank" rel="noopener">Swagger</a></p>
</li>
</ul>
</div><div class="tags"><a href="/tags/Spring-Boot/"><i class="fa fa-tag"></i>Spring Boot</a><a href="/tags/Spring-Security/"><i class="fa fa-tag"></i>Spring Security</a><a href="/tags/Authentication/"><i class="fa fa-tag"></i>Authentication</a><a href="/tags/Authorization/"><i class="fa fa-tag"></i>Authorization</a><a href="/tags/JWT/"><i class="fa fa-tag"></i>JWT</a></div><div class="post-nav"><a class="next" href="/2020/05/12/spring-security-how-filter-chain-works/">Spring Security: How Filter Chain works</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://xpw-osr.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Boot/">Spring Boot</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tools/">Tools</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/Blog/" style="font-size: 15px;">Blog</a> <a href="/tags/Github/" style="font-size: 15px;">Github</a> <a href="/tags/NVM/" style="font-size: 15px;">NVM</a> <a href="/tags/Node-js/" style="font-size: 15px;">Node.js</a> <a href="/tags/Spring-Boot/" style="font-size: 15px;">Spring Boot</a> <a href="/tags/Spring-Security/" style="font-size: 15px;">Spring Security</a> <a href="/tags/Authentication/" style="font-size: 15px;">Authentication</a> <a href="/tags/Authorization/" style="font-size: 15px;">Authorization</a> <a href="/tags/JWT/" style="font-size: 15px;">JWT</a> <a href="/tags/FilterChain/" style="font-size: 15px;">FilterChain</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/05/13/spring-security-authentication-and-authorization-with-jwt-for-separated-backend/">Spring Security: Authentication and Authorization with JWT for separated backend</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/12/spring-security-how-filter-chain-works/">Spring Security: How Filter Chain works</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/09/spring-security-authentication-and-authorization-for-separated-backend/">Spring Security: Authentication and authorization for separated backend</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/05/hexo-create-blog-on-github/">Hexo: Create Blog on Github</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/05/nvm-manage-multiple-nodejs-versions/">NVM: Manage Multiple Node.js Versions</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">Simple Journey.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>