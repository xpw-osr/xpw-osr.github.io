<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>Spring Security: Authentication and Authoriztion with OAuth2 | Simple Journey</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/2.0.4/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/2.1.4/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/2.1.4/toastr.min.css"><meta name="generator" content="Hexo 4.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Spring Security: Authentication and Authoriztion with OAuth2</h1><a id="logo" href="/.">Simple Journey</a><p class="description">Every Little Helps</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/tags/"><i class="fa fa-tag"> Tags</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Spring Security: Authentication and Authoriztion with OAuth2</h1><div class="post-meta">2020-05-26<span> | </span><span class="category"><a href="/categories/Spring-Boot/">Spring Boot</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">Contents</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Why-use-OAuth"><span class="toc-number">1.</span> <span class="toc-text">Why use OAuth</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#What-provided-by-OAuth"><span class="toc-number">2.</span> <span class="toc-text">What provided by OAuth</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Work-flow-of-Authorization-Code-Mode"><span class="toc-number">3.</span> <span class="toc-text">Work flow of Authorization Code Mode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Implementation"><span class="toc-number">4.</span> <span class="toc-text">Implementation</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Auth-Service"><span class="toc-number">4.1.</span> <span class="toc-text">Auth Service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Resources-Service"><span class="toc-number">4.2.</span> <span class="toc-text">Resources Service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Client"><span class="toc-number">4.3.</span> <span class="toc-text">Client</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Test"><span class="toc-number">5.</span> <span class="toc-text">Test</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Conclusion"><span class="toc-number">6.</span> <span class="toc-text">Conclusion</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#References"><span class="toc-number">7.</span> <span class="toc-text">References</span></a></li></ol></div></div><div class="post-content"><p>This post, I will show you how to use OAuth 2 with Spring Security.  There are only few changes between JWT token or not, so, I show them together.</p>
<h3 id="Why-use-OAuth"><a href="#Why-use-OAuth" class="headerlink" title="Why use OAuth"></a>Why use OAuth</h3><p>There are multiple scenarios to make us to find a way to integrate with other services.</p>
<p>For example,</p>
<p>Some of companies provides data storing services, you find a useful usage and they did not provided. So, you want to create app for users. But, there is a problem, the data is stored in services of those companies, you need get the permissions to access them.</p>
<p>The another scene is, you are working for a big company. Your company has multiple services, but don’t want user login again and again when they using different services. You should make sure user only need login once and can using all services with their permissions.</p>
<p>To make these scenarios to true, you can use OAuth.</p>
<p>If you need fetch resources from 3rd party, you need use it as authentication and authorization service. </p>
<p>If you just need use it to make single point login, you just need use it as authentication service, and ignore authorities which are got from authentication service and it should be handled by yourself.</p>
<h3 id="What-provided-by-OAuth"><a href="#What-provided-by-OAuth" class="headerlink" title="What provided by OAuth"></a>What provided by OAuth</h3><p>OAuth provides a safety, open and simple way to authenticate and authorize 3rd party clients to access user’s resources without account and password of user. You can use it get permissions to access user’s resources on 3rd party services, or provide unique authentication and authorization for your all services.</p>
<p>There are 4 authentication modes</p>
<ul>
<li>Authorization code</li>
<li>Implicit</li>
<li>Resource owner password credentials</li>
<li>client credentials</li>
</ul>
<p>In this post, we only talk how to use ‘Authorization code’ mode. It is the strictest mode in these 4 modes.</p>
<h3 id="Work-flow-of-Authorization-Code-Mode"><a href="#Work-flow-of-Authorization-Code-Mode" class="headerlink" title="Work flow of Authorization Code Mode"></a>Work flow of Authorization Code Mode</h3><p><img src="flowchart.png" alt=""></p>
<p>With above chart, when user send request to client and still not sign in, the client will redirect to auth server which is provided by authorization provider to authenticate. </p>
<p>After user signed in auth server and permitted the permissions which are requested, auth server will send the auth code to client. This code only can be used once to get the OAuth token from auth server. When get the token, client may request user’s principal from auth server or not. </p>
<p>Latest, client will request resources which are user wanted with OAuth token from resources server, and send response to user.</p>
<p>You can see, as client, it never touch the user account and password. Sign in process is done on auth server and client only get the token. And when client request resources from resources server, the token also need be validated by auth server. It will make user account will not be known and embezzled by others.</p>
<h3 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h3><p>Now, let’s start to implement them.</p>
<h4 id="Auth-Service"><a href="#Auth-Service" class="headerlink" title="Auth Service"></a>Auth Service</h4><p>First, we need provide an auth server with Spring Security and OAuth 2. There are 3 packages which we need use</p>
<ul>
<li>spring-boot-starter-web</li>
<li>spring-boot-starter-security</li>
<li>spring-cloud-starter-oauth2</li>
</ul>
<p><strong>build.gradle</strong></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">	id <span class="string">'org.springframework.boot'</span> version <span class="string">'2.2.7.RELEASE'</span></span><br><span class="line">	id <span class="string">'io.spring.dependency-management'</span> version <span class="string">'1.0.9.RELEASE'</span></span><br><span class="line">	id <span class="string">'java'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">group = <span class="string">'com.simplejourney'</span></span><br><span class="line">version = <span class="string">'0.0.1-SNAPSHOT'</span></span><br><span class="line">sourceCompatibility = <span class="string">'1.8'</span></span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">	mavenCentral()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ext &#123;</span><br><span class="line">	set(<span class="string">'springCloudVersion'</span>, <span class="string">"Hoxton.SR4"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">	implementation <span class="string">'org.springframework.boot:spring-boot-starter-security'</span></span><br><span class="line">	implementation <span class="string">'org.springframework.boot:spring-boot-starter-web'</span></span><br><span class="line">	implementation <span class="string">'org.springframework.cloud:spring-cloud-starter-oauth2'</span></span><br><span class="line"></span><br><span class="line">	compileOnly <span class="string">'org.projectlombok:lombok:1.18.12'</span></span><br><span class="line">	annotationProcessor <span class="string">'org.projectlombok:lombok:1.18.12'</span></span><br><span class="line"></span><br><span class="line">	testImplementation(<span class="string">'org.springframework.boot:spring-boot-starter-test'</span>) &#123;</span><br><span class="line">		exclude <span class="string">group:</span> <span class="string">'org.junit.vintage'</span>, <span class="string">module:</span> <span class="string">'junit-vintage-engine'</span></span><br><span class="line">	&#125;</span><br><span class="line">	testImplementation <span class="string">'org.springframework.security:spring-security-test'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencyManagement &#123;</span><br><span class="line">	imports &#123;</span><br><span class="line">		mavenBom <span class="string">"org.springframework.cloud:spring-cloud-dependencies:$&#123;springCloudVersion&#125;"</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test &#123;</span><br><span class="line">	useJUnitPlatform()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After project is created, we need add config code which inherited from WebSecurityConfigurerAdapter which looks like normal Spring Security configurations. It is used to manage login actions with username and password.</p>
<p><strong>WebSecurityConfig.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityoauth2auth.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityoauth2auth.services.impl.DemoUserDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.session.SessionInformationExpiredEvent;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.session.SessionInformationExpiredStrategy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DemoUserDetailsServiceImpl userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationManager <span class="title">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureGlobal</span><span class="params">(AuthenticationManagerBuilder builder)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        builder.userDetailsService(userDetailsService).passwordEncoder(passwordEncoder());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http</span><br><span class="line">                .requestMatchers()</span><br><span class="line">                .antMatchers(<span class="string">"/login"</span>, <span class="string">"/oauth/authorize"</span>)</span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin().permitAll()</span><br><span class="line">                .and().sessionManagement().maximumSessions(<span class="number">1</span>)</span><br><span class="line">                .expiredSessionStrategy(<span class="keyword">new</span> SessionInformationExpiredStrategy() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onExpiredSessionDetected</span><span class="params">(SessionInformationExpiredEvent sessionInformationExpiredEvent)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">                        Map&lt;String, Object&gt; results = <span class="keyword">new</span> HashMap&lt;String, Object&gt;() &#123;&#123;</span><br><span class="line">                            put(<span class="string">"code"</span>, HttpServletResponse.SC_UNAUTHORIZED);</span><br><span class="line">                            put(<span class="string">"message"</span>, <span class="string">"Session Expired"</span>);</span><br><span class="line">                        &#125;&#125;;</span><br><span class="line"></span><br><span class="line">                        HttpServletResponse response = sessionInformationExpiredEvent.getResponse();</span><br><span class="line">                        response.setContentType(<span class="string">"json/application;chartset=utf-8"</span>);</span><br><span class="line">                        response.getWriter().write(<span class="string">"session expired"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then, we need add configurations for OAuth 2 which is inherited from AuthorizationServerConfigurerAdaper.</p>
<p><strong>AuthServerConfig.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityoauth2auth.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityoauth2auth.services.impl.DemoClientDetailsServiceImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.DefaultAccessTokenConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenEnhancer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenEnhancerChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.InMemoryTokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtTokenStore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.KeyPair;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthServerConfig</span> <span class="keyword">extends</span> <span class="title">AuthorizationServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;use_jwt_token&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> useJwtToken;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KeyPair keyPair;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DemoClientDetailsServiceImpl clientDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenStore tokenStore;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TokenStore <span class="title">tokenStore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.useJwtToken) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> JwtTokenStore(jwtAccessTokenConverter());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> InMemoryTokenStore();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenEnhancer tokenEnhancer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TokenEnhancer <span class="title">tokenEnhancer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DemoTokenEnhancer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtAccessTokenConverter jwtAccessTokenConverter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JwtAccessTokenConverter <span class="title">jwtAccessTokenConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JwtAccessTokenConverter converter = <span class="keyword">new</span> JwtAccessTokenConverter();</span><br><span class="line">        converter.setKeyPair(<span class="keyword">this</span>.keyPair);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * there is a chance to modify the access token when convert it</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        DefaultAccessTokenConverter accessTokenConverter = <span class="keyword">new</span> DefaultAccessTokenConverter();</span><br><span class="line">        accessTokenConverter.setUserTokenConverter(<span class="keyword">new</span> SubjectAttributeUserTokenConverter());</span><br><span class="line">        converter.setAccessTokenConverter(accessTokenConverter);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> converter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> </span>&#123;</span><br><span class="line">        endpoints</span><br><span class="line">                .authenticationManager(authenticationManager)</span><br><span class="line">                .tokenStore(tokenStore);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.useJwtToken) &#123;</span><br><span class="line">            TokenEnhancerChain tokenEnhancerChain = <span class="keyword">new</span> TokenEnhancerChain();</span><br><span class="line">            tokenEnhancerChain.setTokenEnhancers(</span><br><span class="line">                    Arrays.asList(tokenEnhancer(),</span><br><span class="line">                            jwtAccessTokenConverter()   <span class="comment">// original token will be converted to jwt token</span></span><br><span class="line">                    ));</span><br><span class="line"></span><br><span class="line">            endpoints</span><br><span class="line">                    .accessTokenConverter(jwtAccessTokenConverter)  <span class="comment">// used to decode jwt token when received it</span></span><br><span class="line">                    .tokenEnhancer(tokenEnhancerChain);             <span class="comment">// used to generate jwt token</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            endpoints.tokenEnhancer(tokenEnhancer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        clients.withClientDetails(clientDetailsService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> </span>&#123;</span><br><span class="line">        security.tokenKeyAccess(<span class="string">"permitAll()"</span>)</span><br><span class="line">                .checkTokenAccess(<span class="string">"isAuthenticated()"</span>)</span><br><span class="line">                .allowFormAuthenticationForClients();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>To use JWT, we need provide key pair for JWT</p>
<p><strong>KeyConfig.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityoauth2auth.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigInteger;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyFactory;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPair;</span><br><span class="line"><span class="keyword">import</span> java.security.spec.RSAPrivateKeySpec;</span><br><span class="line"><span class="keyword">import</span> java.security.spec.RSAPublicKeySpec;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KeyConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">KeyPair <span class="title">keyPair</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String privateExponent = <span class="string">"3851612021791312596791631935569878540203393691253311342052463788814433805390794604753109719790052408607029530149004451377846406736413270923596916756321977922303381344613407820854322190592787335193581632323728135479679928871596911841005827348430783250026013354350760878678723915119966019947072651782000702927096735228356171563532131162414366310012554312756036441054404004920678199077822575051043273088621405687950081861819700809912238863867947415641838115425624808671834312114785499017269379478439158796130804789241476050832773822038351367878951389438751088021113551495469440016698505614123035099067172660197922333993"</span>;</span><br><span class="line">            String modulus = <span class="string">"18044398961479537755088511127417480155072543594514852056908450877656126120801808993616738273349107491806340290040410660515399239279742407357192875363433659810851147557504389760192273458065587503508596714389889971758652047927503525007076910925306186421971180013159326306810174367375596043267660331677530921991343349336096643043840224352451615452251387611820750171352353189973315443889352557807329336576421211370350554195530374360110583327093711721857129170040527236951522127488980970085401773781530555922385755722534685479501240842392531455355164896023070459024737908929308707435474197069199421373363801477026083786683"</span>;</span><br><span class="line">            String exponent = <span class="string">"65537"</span>;</span><br><span class="line"></span><br><span class="line">            RSAPublicKeySpec publicSpec = <span class="keyword">new</span> RSAPublicKeySpec(<span class="keyword">new</span> BigInteger(modulus), <span class="keyword">new</span> BigInteger(exponent));</span><br><span class="line">            RSAPrivateKeySpec privateSpec = <span class="keyword">new</span> RSAPrivateKeySpec(<span class="keyword">new</span> BigInteger(modulus), <span class="keyword">new</span> BigInteger(privateExponent));</span><br><span class="line">            KeyFactory factory = KeyFactory.getInstance(<span class="string">"RSA"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> KeyPair(factory.generatePublic(publicSpec), factory.generatePrivate(privateSpec));</span><br><span class="line">        &#125; <span class="keyword">catch</span> ( Exception e ) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Following 2 just show some opportunities to customize token. And also, you can remove them and related configurations from AuthServerConfig.</p>
<p><strong>DemoTokenEnhancer.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityoauth2auth.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.common.OAuth2AccessToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.OAuth2Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenEnhancer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoTokenEnhancer</span> <span class="keyword">implements</span> <span class="title">TokenEnhancer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OAuth2AccessToken <span class="title">enhance</span><span class="params">(OAuth2AccessToken oAuth2AccessToken, OAuth2Authentication oAuth2Authentication)</span> </span>&#123;</span><br><span class="line">        System.out.println(String.format(<span class="string">"Token: %s"</span>, oAuth2AccessToken));</span><br><span class="line">        System.out.println(String.format(<span class="string">"Authentication: %s"</span>, oAuth2Authentication));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * If you want to add more additional information to token, you can do it here like following example</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="comment">//        User user = (User) oAuth2Authentication.getPrincipal();</span></span><br><span class="line"><span class="comment">//        final Map&lt;String, Object&gt; additionalInfo = new HashMap&lt;&gt;();</span></span><br><span class="line"><span class="comment">//        additionalInfo.put("user_name", user.getUsername());</span></span><br><span class="line"><span class="comment">//        ((DefaultOAuth2AccessToken) oAuth2AccessToken).setAdditionalInformation(additionalInfo);</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> oAuth2AccessToken;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>SubjectAttributeUserTokenConverter.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityoauth2auth.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.DefaultUserAuthenticationConverter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubjectAttributeUserTokenConverter</span> <span class="keyword">extends</span> <span class="title">DefaultUserAuthenticationConverter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, ?&gt; convertUserAuthentication(Authentication authentication) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.convertUserAuthentication(authentication);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * You can do some customization here as following example code</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="comment">//        Map&lt;String, Object&gt; response = new LinkedHashMap&lt;&gt;();</span></span><br><span class="line"><span class="comment">//        response.put("sub", authentication.getName());</span></span><br><span class="line"><span class="comment">//        if (authentication.getAuthorities() != null &amp;&amp; !authentication.getAuthorities().isEmpty()) &#123;</span></span><br><span class="line"><span class="comment">//            response.put(AUTHORITIES, AuthorityUtils.authorityListToSet(authentication.getAuthorities()));</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        return response;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We also need to provide UserDetailsService to authenticate and authorize user when they login. The related code have been shown in <a href="https://xpw-osr.github.io/2020/05/09/spring-security-authentication-and-authorization-for-separated-backend/">Spring Security: Authentication and authorization for separated backend</a>,</p>
<p>More than it, we need provide ClientDetailsService to authenticate and authorize client when we use OAuth.</p>
<p><strong>DemoClientDetails.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityoauth2auth.entities;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.ClientDetails;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoClientDetails</span> <span class="keyword">implements</span> <span class="title">ClientDetails</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String clientId;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; resId;</span><br><span class="line">    <span class="keyword">private</span> String clientSecret;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; scope;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; grantTypes;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; redirectUri;</span><br><span class="line">    <span class="keyword">private</span> Collection&lt;GrantedAuthority&gt; authorities;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> accessTokenValiditySeconds;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> refreshTokenValiditySeconds;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; additionalInfo;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DemoClientDetails</span><span class="params">(String clientId,</span></span></span><br><span class="line"><span class="function"><span class="params">                             Set&lt;String&gt; resId,</span></span></span><br><span class="line"><span class="function"><span class="params">                             String clientSecret,</span></span></span><br><span class="line"><span class="function"><span class="params">                             Set&lt;String&gt; scope,</span></span></span><br><span class="line"><span class="function"><span class="params">                             Set&lt;String&gt; grantTypes,</span></span></span><br><span class="line"><span class="function"><span class="params">                             Set&lt;String&gt; uri,</span></span></span><br><span class="line"><span class="function"><span class="params">                             Collection&lt;GrantedAuthority&gt; authorities,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">int</span> accessTokenValiditySeconds,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">int</span> refreshTokenValiditySeconds,</span></span></span><br><span class="line"><span class="function"><span class="params">                             Map&lt;String, Object&gt; additionalInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.clientId = clientId;</span><br><span class="line">        <span class="keyword">this</span>.clientSecret = clientSecret;</span><br><span class="line">        <span class="keyword">this</span>.resId = resId;</span><br><span class="line">        <span class="keyword">this</span>.scope = scope;</span><br><span class="line">        <span class="keyword">this</span>.grantTypes = grantTypes;</span><br><span class="line">        <span class="keyword">this</span>.redirectUri = uri;</span><br><span class="line">        <span class="keyword">this</span>.authorities = authorities;</span><br><span class="line">        <span class="keyword">this</span>.accessTokenValiditySeconds = accessTokenValiditySeconds;</span><br><span class="line">        <span class="keyword">this</span>.refreshTokenValiditySeconds = refreshTokenValiditySeconds;</span><br><span class="line">        <span class="keyword">this</span>.additionalInfo = additionalInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getClientId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> clientId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getResourceIds</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> resId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSecretRequired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getClientSecret</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> clientSecret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isScoped</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getScope</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> scope;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getAuthorizedGrantTypes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> grantTypes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getRegisteredRedirectUri</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redirectUri;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;GrantedAuthority&gt; <span class="title">getAuthorities</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> authorities;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getAccessTokenValiditySeconds</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> accessTokenValiditySeconds;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getRefreshTokenValiditySeconds</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> refreshTokenValiditySeconds;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAutoApprove</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getAdditionalInformation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> additionalInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>DemoClientDetailsServiceImpl.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityoauth2auth.services.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.simplejourney.securityoauth2auth.entities.DemoClientDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.ClientDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.ClientDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.ClientRegistrationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoClientDetailsServiceImpl</span> <span class="keyword">implements</span> <span class="title">ClientDetailsService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, DemoClientDetails&gt; clientDetailsMap = <span class="keyword">new</span> HashMap&lt;String, DemoClientDetails&gt;() &#123;&#123;</span><br><span class="line">        put(<span class="string">"client"</span>,</span><br><span class="line">                <span class="keyword">new</span> DemoClientDetails(</span><br><span class="line">                        <span class="string">"client"</span>,</span><br><span class="line">                        <span class="keyword">null</span>,</span><br><span class="line">                        <span class="keyword">new</span> BCryptPasswordEncoder().encode(<span class="string">"secret"</span>),</span><br><span class="line">                        <span class="keyword">new</span> HashSet&lt;String&gt;() &#123;&#123; add(<span class="string">"APP"</span>); &#125;&#125;,</span><br><span class="line">                        <span class="keyword">new</span> HashSet&lt;String&gt;() &#123;&#123;</span><br><span class="line">                            add(<span class="string">"authorization_code"</span>);</span><br><span class="line">                            add(<span class="string">"refresh_token"</span>);  <span class="comment">// MUST add this if you need refresh token</span></span><br><span class="line">                        &#125;&#125;,</span><br><span class="line">                        <span class="keyword">new</span> HashSet&lt;String&gt;() &#123;&#123; add(<span class="string">"http://oauthcli:8080/login/oauth2/code/oauthsvr"</span>); &#125;&#125;,</span><br><span class="line">                        <span class="keyword">new</span> HashSet&lt;GrantedAuthority&gt;() &#123;&#123; add( <span class="keyword">new</span> SimpleGrantedAuthority(<span class="string">"READ"</span>)); &#125;&#125;, <span class="comment">// MUST NOT be null</span></span><br><span class="line">                        (<span class="keyword">int</span>) TimeUnit.SECONDS.toSeconds(<span class="number">30</span>),</span><br><span class="line">                        (<span class="keyword">int</span>) TimeUnit.DAYS.toSeconds(<span class="number">15</span>),</span><br><span class="line">                        <span class="keyword">null</span>));</span><br><span class="line">    &#125;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClientDetails <span class="title">loadClientByClientId</span><span class="params">(String clientId)</span> <span class="keyword">throws</span> ClientRegistrationException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> clientDetailsMap.get(clientId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If you use web browser to test the client, you need implement a controller to response the ‘user-info-uri’ endpoint request and provide user’s principal.</p>
<p>But if you use Postman, it is not needed.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityoauth2auth.controllers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.OAuth2Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.security.Principal;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;use_jwt_token&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> useJwtToken;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenStore tokenStore;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/info"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;Principal&gt; <span class="title">info</span><span class="params">(String access_token)</span> </span>&#123;</span><br><span class="line">        OAuth2Authentication authentication = tokenStore.readAuthentication(access_token);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == authentication) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(HttpStatus.UNAUTHORIZED);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String username;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.useJwtToken) &#123;</span><br><span class="line">            username = authentication.getUserAuthentication().getPrincipal().toString();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            User user = (User) authentication.getUserAuthentication().getPrincipal();</span><br><span class="line">            username = user.getUsername();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(<span class="keyword">new</span> UserPrincipal(username));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserPrincipal</span> <span class="keyword">implements</span> <span class="title">Principal</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>At last, we need add some settings in ‘application.yml’</p>
<p><strong>application.yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">address:</span> <span class="string">oauthsvr</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line"></span><br><span class="line"><span class="attr">use_jwt_token:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>If you don’t want to use JWT token, you can change value of ‘use_jwt_token’ to ‘false’.</p>
<h4 id="Resources-Service"><a href="#Resources-Service" class="headerlink" title="Resources Service"></a>Resources Service</h4><p>Now, let’s create Resources Service to provide data with Opaque token. </p>
<p>In this service, we only provided 1 api and return an empty list of books.</p>
<p>To use features of OAuth 2 Resources Server, we need add following 3 dependenes</p>
<ul>
<li>spring-boot-starter-web</li>
<li>spring-boot-starter-security</li>
<li>spring-boot-starter-oauth2-resource-server</li>
</ul>
<p><strong>NOTICE</strong> </p>
<p>There is an additional dependence MUST be added, otherwise, the NimbusOpaqueTokenIntrospector will not be found by class loader.</p>
<ul>
<li>oauth2-oidc-sdk</li>
</ul>
<p>Please refer to <a href="https://github.com/spring-projects/spring-security/issues/8391" target="_blank" rel="noopener">Dependency issues in resource server #8391</a></p>
<p><strong>build.gradle</strong></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">	id <span class="string">'org.springframework.boot'</span> version <span class="string">'2.2.7.RELEASE'</span></span><br><span class="line">	id <span class="string">'io.spring.dependency-management'</span> version <span class="string">'1.0.9.RELEASE'</span></span><br><span class="line">	id <span class="string">'java'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">group = <span class="string">'com.simplejourney'</span></span><br><span class="line">version = <span class="string">'0.0.1-SNAPSHOT'</span></span><br><span class="line">sourceCompatibility = <span class="string">'1.8'</span></span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">	mavenCentral()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">	<span class="comment">//	this must be added for 2.2.7.RELEASE for both of JWT and opaque token, otherwise,</span></span><br><span class="line">	<span class="comment">// ----------------------------------</span></span><br><span class="line">	<span class="comment">//  java.lang.IllegalStateException: Failed to introspect Class [org.springframework.security.oauth2.server.resource.introspection.NimbusOpaqueTokenIntrospector] from ClassLoader</span></span><br><span class="line">	<span class="comment">// ----------------------------------</span></span><br><span class="line">	<span class="comment">//  exception will be thrown during launching application</span></span><br><span class="line">	<span class="comment">//  see [Dependency issues in resource server #8391](https://github.com/spring-projects/spring-security/issues/8391)</span></span><br><span class="line">	implementation <span class="string">'com.nimbusds:oauth2-oidc-sdk:8.4'</span></span><br><span class="line"></span><br><span class="line">	implementation <span class="string">'org.springframework.boot:spring-boot-starter-oauth2-resource-server'</span></span><br><span class="line">	implementation <span class="string">'org.springframework.boot:spring-boot-starter-security'</span></span><br><span class="line">	implementation <span class="string">'org.springframework.boot:spring-boot-starter-web'</span></span><br><span class="line"></span><br><span class="line">	testImplementation(<span class="string">'org.springframework.boot:spring-boot-starter-test'</span>) &#123;</span><br><span class="line">		exclude <span class="string">group:</span> <span class="string">'org.junit.vintage'</span>, <span class="string">module:</span> <span class="string">'junit-vintage-engine'</span></span><br><span class="line">	&#125;</span><br><span class="line">	testImplementation <span class="string">'org.springframework.security:spring-security-test'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test &#123;</span><br><span class="line">	useJUnitPlatform()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We add our api and assign the authority for it. </p>
<p><strong>NOTICE</strong></p>
<p>We use scope value of client here. And need add ‘SCOPE_’ prefix for it because when NimbusOpaqueTokenIntrospector parsing the response of auth server, it will append the ‘SCOPE_‘ prefix for all scope names and ‘ROLE_‘ prefix for all authorities.</p>
<p>But, is you use ‘.hasRole(role_name)’, you need not add ‘ROLE_‘ prefix, otherwise, an error will be occurred on it to tell you removing the prefix.</p>
<p><strong>ResourceServerConfig.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityoauth2res.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.server.resource.introspection.OpaqueTokenIntrospector;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceServerConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.security.oauth2.resourceserver.opaque.introspection-uri&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String introspectionUri;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.security.oauth2.resourceserver.opaque.introspection-client-id&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String clientId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.security.oauth2.resourceserver.opaque.introspection-client-secret&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String clientSecret;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">OpaqueTokenIntrospector <span class="title">opaqueTokenIntrospector</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DemoOpaqueTokenIntrospector(introspectionUri, clientId, clientSecret);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http</span><br><span class="line">                .authorizeRequests(authorize -&gt;</span><br><span class="line">                        authorize</span><br><span class="line">                                .antMatchers(HttpMethod.GET, <span class="string">"/book/list"</span>).hasAuthority(<span class="string">"SCOPE_APP"</span>)</span><br><span class="line">                                .anyRequest().authenticated()</span><br><span class="line">                )</span><br><span class="line">                .oauth2ResourceServer(oauth2ResourceServer -&gt; &#123;</span><br><span class="line">                    oauth2ResourceServer.opaqueToken().introspector(opaqueTokenIntrospector());</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Because the type of scopes of ClientDetails is Set<String> and it will be serialized to a JSONARRAY, but getScope() method in TokenIntrospectionSuccessResponse only can parse JSONString for ‘scope’ field. So, we need add this introspector to override and get scope and authorities from response.</p>
<p><strong>DemoOpaqueTokenIntrospector.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityoauth2res.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.core.DefaultOAuth2AuthenticatedPrincipal;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.core.OAuth2AuthenticatedPrincipal;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.server.resource.introspection.NimbusOpaqueTokenIntrospector;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.server.resource.introspection.OAuth2IntrospectionClaimNames;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.server.resource.introspection.OpaqueTokenIntrospector;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * We need replace introsepctor with customized because getScope() method of TokenIntrospectionSuccessResponse cannot deserialize scope of type Set&lt;String&gt;</span></span><br><span class="line"><span class="comment"> * see [TokenIntrospectionSuccessResponse doesn't support parsing scopes presented as JSONArray #7563](https://github.com/spring-projects/spring-security/issues/7563)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoOpaqueTokenIntrospector</span> <span class="keyword">implements</span> <span class="title">OpaqueTokenIntrospector</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> OpaqueTokenIntrospector delegate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DemoOpaqueTokenIntrospector</span><span class="params">(String introspectionUri, String clientId, String clientSecret)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.delegate = <span class="keyword">new</span> NimbusOpaqueTokenIntrospector(introspectionUri, clientId, clientSecret);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OAuth2AuthenticatedPrincipal <span class="title">introspect</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        OAuth2AuthenticatedPrincipal principal = <span class="keyword">this</span>.delegate.introspect(token);</span><br><span class="line">        <span class="keyword">return</span> oAuth2AuthenticatedPrincipal(principal);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> DefaultOAuth2AuthenticatedPrincipal <span class="title">oAuth2AuthenticatedPrincipal</span><span class="params">(OAuth2AuthenticatedPrincipal principal)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * In ClientDetails interface of oauth2 server, there are 2 types of things to indicate the permissions of client</span></span><br><span class="line"><span class="comment">         * 1. scopes</span></span><br><span class="line"><span class="comment">         * 2. authorities</span></span><br><span class="line"><span class="comment">         * You can get both of them from 'principal.attributes' which got from auth server</span></span><br><span class="line"><span class="comment">         * Generally, you can use scope to grant permission for client,  -&gt; 'SCOPE_'</span></span><br><span class="line"><span class="comment">         * And also, you can use 'authorities' to do it.    -&gt; 'ROLE_'</span></span><br><span class="line"><span class="comment">         * Or, both of them</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * But, notice, the scopes are permissions of client, and authorities are user's.</span></span><br><span class="line"><span class="comment">         * See [Spring oauth2 scope vs authorities(roles)](https://stackoverflow.com/questions/32092749/spring-oauth2-scope-vs-authoritiesroles)</span></span><br><span class="line"><span class="comment">         * And [The OAuth 2.0 Authorization Framework - 3.3.  Access Token Scope](https://tools.ietf.org/html/rfc6749#section-3.3)</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; scopes = principal.getAttribute(OAuth2IntrospectionClaimNames.SCOPE);</span><br><span class="line">        Collection&lt;GrantedAuthority&gt; grantedAuthorities = scopes.stream().map(scope -&gt; <span class="string">"SCOPE_"</span> + scope).map(SimpleGrantedAuthority::<span class="keyword">new</span>).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line"><span class="comment">//        List&lt;String&gt; authorities = principal.getAttribute("authorities");</span></span><br><span class="line"><span class="comment">//        Collection&lt;GrantedAuthority&gt; grantedAuthorities = authorities.stream().map(authority -&gt; "ROLE_" + authority).map(SimpleGrantedAuthority::new).collect(Collectors.toList());</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultOAuth2AuthenticatedPrincipal(principal.getName(), principal.getAttributes(), grantedAuthorities);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Add a simple api for return books’ list.</p>
<p><strong>BookController.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityoauth2res.controllers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/book"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/list"</span>)</span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;List&lt;String&gt;&gt; list() &#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(<span class="keyword">new</span> ArrayList&lt;&gt;());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>application.yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">oauth2:</span></span><br><span class="line">      <span class="attr">resourceserver:</span></span><br><span class="line">        <span class="attr">opaque:</span></span><br><span class="line">          <span class="attr">introspection-uri:</span> <span class="string">"http://oauthsvr:8081/oauth/check_token"</span></span><br><span class="line">          <span class="attr">introspection-client-id:</span> <span class="string">client</span></span><br><span class="line">          <span class="attr">introspection-client-secret:</span> <span class="string">secret</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">address:</span> <span class="string">oauthres</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8082</span></span><br></pre></td></tr></table></figure>



<h4 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h4><p>Finally, we need create client service which will call auth server to authenticate and authorize for user, and store access token in session.</p>
<p>To make OAuth 2 client side, we need add following dependences</p>
<ul>
<li>spring-boot-starter-web</li>
<li>spring-boot-starter-security</li>
<li>spring-boot-starter-oauth2-client</li>
</ul>
<p><strong>build.gradle</strong></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">	id <span class="string">'org.springframework.boot'</span> version <span class="string">'2.2.7.RELEASE'</span></span><br><span class="line">	id <span class="string">'io.spring.dependency-management'</span> version <span class="string">'1.0.9.RELEASE'</span></span><br><span class="line">	id <span class="string">'java'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">group = <span class="string">'com.simplejourney'</span></span><br><span class="line">version = <span class="string">'0.0.1-SNAPSHOT'</span></span><br><span class="line">sourceCompatibility = <span class="string">'1.8'</span></span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">	mavenCentral()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">	implementation <span class="string">'org.springframework.boot:spring-boot-starter-oauth2-client'</span></span><br><span class="line">	implementation <span class="string">'org.springframework.boot:spring-boot-starter-security'</span></span><br><span class="line">	implementation <span class="string">'org.springframework.boot:spring-boot-starter-web'</span></span><br><span class="line"></span><br><span class="line">	testImplementation(<span class="string">'org.springframework.boot:spring-boot-starter-test'</span>) &#123;</span><br><span class="line">		exclude <span class="string">group:</span> <span class="string">'org.junit.vintage'</span>, <span class="string">module:</span> <span class="string">'junit-vintage-engine'</span></span><br><span class="line">	&#125;</span><br><span class="line">	testImplementation <span class="string">'org.springframework.security:spring-security-test'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test &#123;</span><br><span class="line">	useJUnitPlatform()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>WebSecurityConfig.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityoauth2client.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.Customizer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http</span><br><span class="line">                .authorizeRequests(authorize -&gt; authorize.anyRequest().authenticated())</span><br><span class="line">                .oauth2Login(Customizer.withDefaults())</span><br><span class="line">                .oauth2Client(Customizer.withDefaults());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>HomeController.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.simplejourney.securityoauth2client.controllers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">home</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(<span class="string">"Hello, world"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>application.yml</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">oauth2:</span></span><br><span class="line">      <span class="attr">client:</span></span><br><span class="line">        <span class="attr">registration:</span></span><br><span class="line">          <span class="attr">oauthsvr:</span></span><br><span class="line">            <span class="attr">client-id:</span> <span class="string">client</span></span><br><span class="line">            <span class="attr">client-secret:</span> <span class="string">secret</span></span><br><span class="line">            <span class="attr">authorization-grant-type:</span> <span class="string">authorization_code</span></span><br><span class="line">            <span class="attr">redirect-uri:</span> <span class="string">"&#123;baseUrl&#125;/login/oauth2/code/&#123;registrationId&#125;"</span></span><br><span class="line">            <span class="attr">scope:</span> <span class="string">APP</span></span><br><span class="line">            <span class="attr">client-authentication-method:</span> <span class="string">basic</span></span><br><span class="line">        <span class="attr">provider:</span></span><br><span class="line">          <span class="attr">oauthsvr:</span></span><br><span class="line">            <span class="attr">authorization-uri:</span> <span class="string">http://oauthsvr:8081/oauth/authorize</span></span><br><span class="line">            <span class="attr">token-uri:</span> <span class="string">http://oauthsvr:8081/oauth/token</span></span><br><span class="line">            <span class="attr">user-info-uri:</span> <span class="string">http://oauthsvr:8081/user/info</span></span><br><span class="line">            <span class="attr">user-name-attribute:</span> <span class="string">name</span></span><br><span class="line">            <span class="attr">user-info-authentication-method:</span> <span class="string">form</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">address:</span> <span class="string">oauthcli</span></span><br></pre></td></tr></table></figure>

<h3 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h3><p>OK, all done. let’s test the results.</p>
<p>Before start services, we need add some domain name to ‘/etc/hosts’ file to separate each services,</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1	localhost oauthsvr oauthcli oauthres</span><br></pre></td></tr></table></figure>

<p>otherwise, you will see following error in browser because there is cookie conflict for ‘localhost’</p>
<p><img src="session_cookie_conflict.png" alt=""></p>
<p>Open your Postman, and add a new request.  as following</p>
<p><img src="request_with_authorization.png" alt=""></p>
<p>Then, click the ‘Get New Access Token’ button, and fill as following</p>
<p><img src="get_new_access_token.png" alt=""></p>
<p>Start all services, then click ‘Request Token’ button</p>
<p>You will see a popup dialog which ask you enter the username and password, fill them</p>
<p><img src="login_window.png" alt=""></p>
<p>And click ‘Authorize’ button in next popup dialog</p>
<p><img src="permit_window.png" alt=""></p>
<p>After these, Postman will received tokens and show them in dialog</p>
<p><img src="received_tokens.png" alt=""></p>
<p>click ‘Use Token’ button to use the tokens for your request, then click ‘Send’ button behind the request uri, you can get the empty list for books</p>
<p><img src="book_list_response.png" alt=""></p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>OK, the services work well now.</p>
<p>If you have any questions or suggestions, please feel free to submit your comments to <a href="https://github.com/xpw-osr/xpw-osr.github.io/issues/6" target="_blank" rel="noopener">issue</a>.</p>
<p>The demo projects you can download from Github with following links</p>
<ul>
<li><a href="https://github.com/xpw-osr/blog-examples/tree/master/Spring%20Boot/security-oauth2-auth" target="_blank" rel="noopener">Auth Service</a></li>
<li><a href="https://github.com/xpw-osr/blog-examples/tree/master/Spring%20Boot/security-oauth2-res" target="_blank" rel="noopener">Resources Service</a></li>
<li><a href="https://github.com/xpw-osr/blog-examples/tree/master/Spring%20Boot/security-oauth2-client" target="_blank" rel="noopener">Client Service</a></li>
</ul>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><ul>
<li><p><a href="https://docs.spring.io/spring-security/site/docs/current/reference/html5/#oauth2" target="_blank" rel="noopener">Spring Security Reference - 12. OAuth2</a></p>
</li>
<li><p><a href="https://tools.ietf.org/html/rfc6749#section-3.3" target="_blank" rel="noopener">The OAuth 2.0 Authorization Framework - 3.3.  Access Token Scope</a></p>
</li>
<li><p><a href="https://github.com/spring-projects/spring-security" target="_blank" rel="noopener">spring-projects/spring-security</a></p>
</li>
<li><p><a href="https://stackoverflow.com/questions/32092749/spring-oauth2-scope-vs-authoritiesroles" target="_blank" rel="noopener">Spring oauth2 scope vs authorities(roles)</a></p>
</li>
<li><p><a href="https://github.com/spring-projects/spring-security/issues/8391" target="_blank" rel="noopener">Dependency issues in resource server #8391</a></p>
</li>
<li><p><a href="https://github.com/spring-projects/spring-security/issues/5946" target="_blank" rel="noopener">Not able to connect Spring OAuth2 Authorization Server with Client #5946</a></p>
</li>
</ul>
</div><div class="tags"><a href="/tags/Spring-Boot/"><i class="fa fa-tag"></i>Spring Boot</a><a href="/tags/Spring-Security/"><i class="fa fa-tag"></i>Spring Security</a><a href="/tags/Authentication/"><i class="fa fa-tag"></i>Authentication</a><a href="/tags/Authorization/"><i class="fa fa-tag"></i>Authorization</a><a href="/tags/OAuth2/"><i class="fa fa-tag"></i>OAuth2</a></div><div class="post-nav"><a class="pre" href="/2020/05/31/spring-security-authentication-and-authorization-with-acl/">spring security authentication and authorization with acl</a><a class="next" href="/2020/05/13/spring-security-authentication-and-authorization-with-jwt-for-separated-backend/">Spring Security: Authentication and Authorization with JWT for separated backend</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://xpw-osr.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Boot/">Spring Boot</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tools/">Tools</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/Blog/" style="font-size: 15px;">Blog</a> <a href="/tags/Github/" style="font-size: 15px;">Github</a> <a href="/tags/NVM/" style="font-size: 15px;">NVM</a> <a href="/tags/Node-js/" style="font-size: 15px;">Node.js</a> <a href="/tags/Spring-Boot/" style="font-size: 15px;">Spring Boot</a> <a href="/tags/Spring-Security/" style="font-size: 15px;">Spring Security</a> <a href="/tags/Authentication/" style="font-size: 15px;">Authentication</a> <a href="/tags/Authorization/" style="font-size: 15px;">Authorization</a> <a href="/tags/JWT/" style="font-size: 15px;">JWT</a> <a href="/tags/OAuth2/" style="font-size: 15px;">OAuth2</a> <a href="/tags/FilterChain/" style="font-size: 15px;">FilterChain</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/05/31/spring-security-authentication-and-authorization-with-acl/">spring security authentication and authorization with acl</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/26/spring-security-authentication-and-authoriztion-with-oauth2/">Spring Security: Authentication and Authoriztion with OAuth2</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/13/spring-security-authentication-and-authorization-with-jwt-for-separated-backend/">Spring Security: Authentication and Authorization with JWT for separated backend</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/12/spring-security-how-filter-chain-works/">Spring Security: How Filter Chain works</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/09/spring-security-authentication-and-authorization-for-separated-backend/">Spring Security: Authentication and authorization for separated backend</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/05/hexo-create-blog-on-github/">Hexo: Create Blog on Github</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/05/nvm-manage-multiple-nodejs-versions/">NVM: Manage Multiple Node.js Versions</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">Simple Journey.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="Copy Successed!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>